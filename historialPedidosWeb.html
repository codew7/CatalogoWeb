<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos Web</title>
  <link rel="icon" href="faviconnegro.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Firebase Auth Check -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script src="config.js"></script>
  <script>
    firebase.initializeApp(firebaseConfig);
    
    // Sistema de autenticaci칩n completo
    let admin = false;
    let authResolved = false;
    
    // Lista de emails de administradores
    const adminEmails = ["distribuidorahomepoint@gmail.com"];

    // Funci칩n para redirigir a login con par치metro de retorno
    function redirigirALogin() {
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = `login.html?redirect=${currentUrl}`;
    }

    // Timeout de seguridad: verificar autenticaci칩n despu칠s de 5 segundos
    setTimeout(() => {
        if (!authResolved) {
            console.log('Timeout de autenticaci칩n alcanzado, redirigiendo a login');
            redirigirALogin();
        }
    }, 5000);

    firebase.auth().onAuthStateChanged(user => {
        console.log('Firebase Auth State Changed:', user ? 'Usuario autenticado' : 'No hay usuario');
        authResolved = true;
        
        if (user) {
            // Verificar si es administrador
            admin = adminEmails.includes(user.email);
            console.log('Usuario admin:', admin);
            
            // Mostrar indicador apropiado
            mostrarIndicadorUsuario(user, admin);
            
            // Inicializar la p치gina despu칠s de la autenticaci칩n
            inicializarHistorialPedidos();
        } else {
            redirigirALogin();
        }
    });

    // Funci칩n para mostrar indicador de usuario
    function mostrarIndicadorUsuario(user, esAdmin) {
        const userIndicator = document.getElementById('userIndicator');
        const adminIndicator = document.getElementById('adminIndicator');
        
        // Verificar que los elementos existan antes de manipular sus estilos
        if (adminIndicator && userIndicator) {
            if (esAdmin) {
                adminIndicator.style.display = 'block';
                userIndicator.style.display = 'none';
            } else {
                adminIndicator.style.display = 'none';
                userIndicator.style.display = 'block';
            }
        } else {
            console.error('No se encontraron los elementos userIndicator o adminIndicator');
        }
    }

    // Funci칩n para cerrar sesi칩n
    function cerrarSesion() {
        firebase.auth().signOut().then(() => {
            console.log('Sesi칩n cerrada exitosamente');
            redirigirALogin();
        }).catch((error) => {
            console.error('Error al cerrar sesi칩n:', error);
            alert('Error al cerrar sesi칩n. Int칠ntalo de nuevo.');
        });
    }
  </script>
  <!-- Fin Firebase Auth Check -->

  <style>
    /* === RESET Y VARIABLES === */
    :root {
      --primary-color: #4CAF50;
      --primary-dark: #388E3C;
      --primary-light: #81C784;
      --secondary-color: #2196F3;
      --accent-color: #FFD600;
      --danger-color: #f44336;
      --warning-color: #FF9800;
      --success-color: #25D366;
      --text-dark: #212121;
      --text-light: #757575;
      --bg-light: #f5f5f5;
      --bg-white: #ffffff;
      --border-color: #e0e0e0;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      overflow-x: hidden;
    }

    /* === HEADER === */
    header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      padding: 1.5rem 1.5rem 2rem 1.5rem;
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
    }

    header h1 {
      margin: 0 0 1.5rem 0;
      font-size: 2rem;
      color: white;
      letter-spacing: 0.5px;
      font-weight: 700;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* === MEN칔 HAMBURGUESA === */
    .hamburger-menu {
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 1001;
    }

    .hamburger-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: var(--transition);
      padding: 8px;
    }

    .hamburger-icon:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .hamburger-icon span {
      width: 24px;
      height: 2.5px;
      background: white;
      border-radius: 2px;
      transition: var(--transition);
    }

    .hamburger-icon.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger-icon.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger-icon.active span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    .menu-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      min-width: 280px;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: var(--transition);
    }

    .menu-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .menu-item {
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-dark);
      font-weight: 600;
      font-size: 0.95rem;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item:hover {
      background: var(--bg-light);
    }

    .menu-item i {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .menu-item.dashboard i {
      color: #9C27B0;
    }

    .menu-item.download i {
      color: #2196F3;
    }

    .menu-item.clear-filters {
      background: linear-gradient(135deg, #d3b76b 0%, #d3b76b 100%);
      color: white;
      font-weight: 600;
      border: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .menu-item.clear-filters i {
      color: white;
    }

    .menu-item.checkbox-item {
      cursor: default;
    }

    .menu-item.checkbox-item:hover {
      background: white;
    }

    .menu-checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      cursor: pointer;
    }

    .menu-checkbox-wrapper:hover {
      opacity: 0.8;
    }

    .menu-checkbox-wrapper input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2196F3;
    }

    .menu-checkbox-wrapper i {
      color: #2196F3;
    }

    /* === CATEGOR칈A DE FILTROS EN MEN칔 === */
    .menu-category-title {
      padding: 0.75rem 1.25rem;
      background: var(--bg-light);
      color: var(--text-light);
      font-weight: 700;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border-color);
    }

    .menu-filters-container {
      padding: 1rem 1.25rem;
      background: #fafafa;
      border-bottom: 1px solid var(--border-color);
    }

    .menu-filter-group {
      margin-bottom: 0.75rem;
    }

    .menu-filter-group:last-child {
      margin-bottom: 0;
    }

    .menu-filter-group-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu-filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .menu-filter-btn {
      padding: 0.4rem 0.9rem;
      border: 1.5px solid;
      border-radius: 18px;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      background: white;
      flex-shrink: 0;
    }

    .menu-filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* === BUSCADOR Y FILTRO DE NOTA EN MEN칔 === */
    .menu-search-input,
    .menu-note-select {
      width: 100%;
      padding: 0.65rem 0.85rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-family: inherit;
      transition: var(--transition);
      background: white;
      color: var(--text-dark);
    }

    .menu-search-input:focus,
    .menu-note-select:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .menu-search-input::placeholder {
      color: var(--text-light);
      font-style: italic;
    }

    .menu-note-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 12px;
      padding-right: 2.5rem;
    }

    /* === INDICADORES DE USUARIO === */
    .user-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 0.5rem 1rem;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }

    .user-indicator:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .user-indicator i {
      font-size: 1rem;
    }

    .logout-btn {
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.35);
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      padding: 0;
      box-shadow: none;
      flex-shrink: 0;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.4);
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .logout-btn i {
      font-size: 0.9rem;
    }

    /* === INDICADORES DE FILTROS ACTIVOS === */
    .active-filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      margin-top: 0.75rem;
      padding: 0.5rem 1rem;
      min-height: 20px;
    }

    .filter-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(255, 255, 255, 0.9);
      color: var(--text-color);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: var(--transition);
      border: 1px solid rgba(79, 70, 229, 0.2);
    }

    .filter-indicator i {
      font-size: 0.85rem;
      color: var(--primary-color);
    }

    .filter-indicator:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    .filter-indicator.status {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
      border-color: rgba(34, 197, 94, 0.3);
    }

    .filter-indicator.delivery {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
      border-color: rgba(59, 130, 246, 0.3);
    }

    .filter-indicator.recurring {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.05));
      border-color: rgba(168, 85, 247, 0.3);
    }

    .filter-indicator.units {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
      border-color: rgba(249, 115, 22, 0.3);
    }

    .filter-indicator.search {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(236, 72, 153, 0.05));
      border-color: rgba(236, 72, 153, 0.3);
    }

    .filter-indicator.note {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
      border-color: rgba(234, 179, 8, 0.3);
    }

    /* === FILTROS === */
    #filtroStatusBtns {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.5rem;
    }

    .filtro-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      flex-wrap: wrap;
    }

    .filtro-row button {
      padding: 0.5rem 1.25rem;
      border: 2px solid white;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      white-space: nowrap;
    }

    .filtro-row button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .filtro-row button:active {
      transform: translateY(0);
    }

    /* === CONTENEDOR PRINCIPAL === */
    .main-container {
      max-width: 100%;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .table-wrapper {
      background: var(--bg-white);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* === TABLA === */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 800px;
    }

    thead {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 1rem 0.75rem;
      color: white;
      font-weight: 600;
      text-align: center;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--primary-dark);
    }

    tbody tr {
      transition: var(--transition);
      border-bottom: 1px solid var(--border-color);
      background: white;
    }

    tbody tr:hover {
      background: #e8f5e9;
      box-shadow: 0 3px 12px rgba(76, 175, 80, 0.2);
      transform: scale(1.01);
    }

    td {
      padding: 1rem 0.75rem;
      text-align: center;
      vertical-align: middle;
      font-size: 0.9rem;
      color: var(--text-dark);
    }

    /* === COLUMNAS === */
    .col-indicador { width: 3%; min-width: 40px; }
    .col-nombre { width: 18%; min-width: 150px; text-align: left; }
    .col-fecha { width: 12%; min-width: 120px; }
    .col-entrega { width: 10%; min-width: 90px; }
    .col-estado { width: 10%; min-width: 90px; }
    .col-unidades { width: 8%; min-width: 60px; }
    .col-nota { width: 22%; min-width: 180px; }
    .col-eliminar { width: 14%; min-width: 120px; }

    /* === ELEMENTOS ESPECIALES === */
    .dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--danger-color);
      animation: pulse 2s infinite;
      box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(244, 67, 54, 0);
      }
    }

    .cancelado-row {
      background: #f5f5f5 !important;
      color: #9e9e9e !important;
      opacity: 0.7;
    }

    .cancelado-row:hover {
      background: #eeeeee !important;
    }

    /* === CAMPO DE NOTA === */
    .nota-input {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-family: inherit;
      transition: var(--transition);
      background: white;
    }

    .nota-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    /* === BOTONES DE ACCI칍N === */
    button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      font-size: 0.85rem;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      box-shadow: var(--shadow-sm);
    }

    .btn-icon:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-icon:active {
      transform: translateY(0);
    }

    .btn-whatsapp {
      background: var(--success-color);
      color: white;
    }

    .btn-whatsapp:disabled {
      background: #9e9e9e;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .btn-copy {
      background: var(--warning-color);
      color: white;
    }

    .btn-delete {
      background: var(--danger-color);
      color: white;
    }

    /* === BOT칍N DESCARGAR TODO === */
    #btnDescargarTodo {
      background: linear-gradient(135deg, var(--secondary-color) 0%, #1976D2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1rem auto;
    }

    #btnDescargarTodo:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%);
    }

    #btnDescargarTodo i {
      font-size: 1.2rem;
    }

    #pieDescargarTodo {
      text-align: center;
      padding: 2rem 0;
    }

    /* === BADGES === */
    .badge {
      display: inline-block;
      padding: 0.35rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-abierto {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-cerrado {
      background: #e0e0e0;
      color: #616161;
    }

    .badge-entregado {
      background: #e1f5fe;
      color: #0277bd;
    }

    /* === BADGE CONTADOR PEDIDOS === */
    .order-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border-radius: 12px;
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      font-weight: 700;
 
      box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
      min-width: 28px;
    }

    .order-count-badge i {
      font-size: 0.7rem;
      margin-right: 0.25rem;
    }

    /* === BOT칍N DASHBOARD === */
    .btn-dashboard {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 0.75rem 2rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin: 1rem auto;
    }

    .btn-dashboard:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      background: linear-gradient(135deg, #AB47BC 0%, #8E24AA 100%);
    }

    .btn-dashboard i {
      font-size: 1.2rem;
    }

    /* Estilo hover espec칤fico para bot칩n Descargar Todo */
    #btnDescargarTodoTop:hover {
      background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%) !important;
    }

    /* === FILTRO CLIENTES RECURRENTES === */
    .filter-returning-customers {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: white;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      box-shadow: var(--shadow-md);
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-dark);
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
    }

    .filter-returning-customers:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      background: #f5f5f5;
    }

    .filter-returning-customers input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #2196F3;
    }

    .filter-returning-customers i {
      font-size: 1.1rem;
      color: #2196F3;
    }

    /* === MODAL DASHBOARD === */
    .dashboard-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 1rem;
    }

    .dashboard-content {
      background: white;
      border-radius: var(--radius-lg);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: fadeInUp 0.4s ease-out;
    }

    .dashboard-header {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      padding: 1.5rem 2rem;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-header h2 {
      margin: 0;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .dashboard-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .dashboard-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .dashboard-body {
      padding: 2rem;
    }

    .dashboard-filters {
      background: var(--bg-light);
      padding: 1.5rem;
      border-radius: var(--radius-md);
      margin-bottom: 2rem;
    }

    .dashboard-filters h3 {
      margin: 0 0 1rem 0;
      color: var(--text-dark);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .date-filter-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      min-width: 200px;
    }

    .date-filter-group label {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.85rem;
    }

    .date-filter-group input {
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .date-filter-group input:focus {
      outline: none;
      border-color: #9C27B0;
      box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
    }

    .btn-apply-filter {
      background: #9C27B0;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      align-self: flex-end;
      margin-top: 1.5rem;
    }

    .btn-apply-filter:hover {
      background: #7B1FA2;
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
      border-color: #9C27B0;
    }

    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-dark);
      margin: 0.5rem 0;
    }

    .stat-label {
      font-size: 0.95rem;
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card.abiertos::before {
      background: linear-gradient(90deg, #4CAF50, #66BB6A);
    }

    .stat-card.abiertos .stat-icon {
      color: #4CAF50;
    }

    .stat-card.cerrados::before {
      background: linear-gradient(90deg, #757575, #9E9E9E);
    }

    .stat-card.cerrados .stat-icon {
      color: #757575;
    }

    .stat-card.totales::before {
      background: linear-gradient(90deg, #2196F3, #42A5F5);
    }

    .stat-card.totales .stat-icon {
      color: #2196F3;
    }

    /* === RESPONSIVE === */
    @media (max-width: 1200px) {
      .main-container {
        padding: 0 0.5rem;
        margin: 1.5rem auto;
      }

      table {
        min-width: 700px;
      }
    }

    @media (max-width: 900px) {
      header {
        padding: 1rem 1rem 1rem 1rem;
      }

      header h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }

      .user-indicator {
        top: 0.5rem;
        left: 0.5rem;
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
      }

      .user-indicator span {
        display: none;
      }

      .user-indicator i {
        font-size: 1.1rem;
      }

      .logout-btn {
        width: 24px;
        height: 24px;
      }

      .filtro-row button {
        padding: 0.4rem 1rem;
        font-size: 0.85rem;
      }

      .main-container {
        margin: 1rem auto;
      }

      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
      }

      .btn-icon {
        width: 32px;
        height: 32px;
      }

      .active-filters-container {
        padding: 0.4rem 0.75rem;
        gap: 0.4rem;
      }

      .filter-indicator {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
      }
    }

    @media (max-width: 600px) {
      header {
        padding: 0.75rem 0.5rem 1rem 0.5rem;
      }

      header h1 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }

      .active-filters-container {
        padding: 0.35rem 0.5rem;
        gap: 0.35rem;
        margin-top: 0.5rem;
      }

      .filter-indicator {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
        gap: 0.25rem;
      }

      .filter-indicator i {
        font-size: 0.75rem;
      }

      .main-container {
        padding: 0 0.25rem;
        margin: 0.75rem auto;
      }

      .table-wrapper {
        border-radius: var(--radius-sm);
        margin-bottom: 1rem;
      }

      table {
        min-width: 600px;
      }

      th, td {
        padding: 0.6rem 0.4rem;
        font-size: 0.8rem;
      }

      .filtro-row {
        gap: 0.4rem;
      }

      .filtro-row button {
        padding: 0.35rem 0.8rem;
        font-size: 0.8rem;
      }

      .btn-icon {
        width: 30px;
        height: 30px;
      }

      .nota-input {
        font-size: 0.8rem;
        padding: 0.4rem;
      }

      #btnDescargarTodo {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
      }
    }

    /* === ANIMACIONES === */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    tbody tr {
      animation: fadeInUp 0.3s ease-out;
    }

    /* === SCROLL PERSONALIZADO === */
    .table-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 4px;
    }

    .table-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

  </style>
</head>
<body>
  <header>
    <!-- Men칰 Hamburguesa -->
    <div class="hamburger-menu">
      <div class="hamburger-icon" onclick="toggleMenu()">
        <span></span>
        <span></span>
        <span></span>
      </div>
      <div class="menu-dropdown" id="menuDropdown">
        <div class="menu-item dashboard" onclick="abrirDashboard(); toggleMenu();">
          <i class="bi bi-bar-chart-fill"></i>
          <span>Dashboard</span>
        </div>
        <div class="menu-item download" onclick="if (!descargandoTodo) { cargarPedidosTodos(); toggleMenu(); }">
          <i class="bi bi-download"></i>
          <span>Descargar Todo</span>
        </div>
        <div class="menu-item clear-filters" onclick="limpiarFiltros(); toggleMenu();">
          <i class="bi bi-x-circle-fill"></i>
          <span>Limpiar Filtros</span>
        </div>
        <div class="menu-item checkbox-item">
          <label class="menu-checkbox-wrapper">
            <input type="checkbox" id="checkClientesRecurrentesMenu" onchange="toggleFiltroClientesRecurrentes()">
            <i class="bi bi-arrow-repeat"></i>
            <span>Clientes recurrentes</span>
          </label>
        </div>
        <div class="menu-item checkbox-item">
          <label class="menu-checkbox-wrapper">
            <input type="checkbox" id="checkMasDeUnaUnidad" onchange="toggleFiltroMasDeUnaUnidad()">
            <i class="bi bi-box-seam"></i>
            <span>Pedidos con +1 unidad</span>
          </label>
        </div>
        
        <!-- Buscador por nombre -->
        <div class="menu-category-title">
          <i class="bi bi-search"></i> B칰squeda
        </div>
        <div class="menu-filters-container">
          <div class="menu-filter-group">
            <input 
              type="text" 
              id="searchNombre" 
              class="menu-search-input" 
              placeholder="Buscar por nombre..."
              oninput="aplicarFiltros()"
            >
          </div>
        </div>
        
        <!-- Filtro por tipo de nota -->
        <div class="menu-category-title">
          <i class="bi bi-card-text"></i> Nota
        </div>
        <div class="menu-filters-container">
          <div class="menu-filter-group">
            <select id="filtroNota" class="menu-note-select" onchange="aplicarFiltros()">
              <option value="">Todas las notas</option>
              <option value="esperando respuesta">Esperando respuesta</option>
              <option value="esperando cierre">Esperando cierre</option>
              <option value="espera cotizaci칩n">Espera cotizaci칩n</option>
              <option value="esperando pago">Esperando pago</option>
              <option value="pago">Pago</option>
              <option value="retira">Retira</option>
              <option value="no responde">No responde</option>
              <option value="sin_nota">Sin nota</option>
            </select>
          </div>
        </div>
        
        <!-- Categor칤a de Filtros -->
        <div class="menu-category-title">
          <i class="bi bi-funnel"></i> Filtros
        </div>
        <div class="menu-filters-container" id="menuFiltrosContainer">
          <!-- Los botones de filtro se renderizar치n aqu칤 din치micamente -->
        </div>
      </div>
    </div>

    <h1>游늶 Pedidos Web</h1>
    
    <!-- Indicadores de filtros activos -->
    <div class="active-filters-container" id="activeFiltersContainer"></div>
    
    <!-- Indicador de Administrador -->
    <div id="adminIndicator" class="user-indicator" style="display: none;">
      <i class="bi bi-shield-check"></i>
      <span>Modo Administrador</span>
    </div>
    
    <!-- Indicador de Usuario Normal -->
    <div id="userIndicator" class="user-indicator" style="display: none;">
      <i class="bi bi-person-circle"></i>
      <span>Usuario</span>
      <button class="logout-btn" onclick="cerrarSesion()" title="Cerrar Sesi칩n">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
    
    <div id="filtroStatusBtns" style="display: none;"></div>
  </header>

  <div class="main-container">
    <div class="table-wrapper">
      <div class="table-scroll">
        <table id="tabla">
          <thead>
            <tr>
              <th class="col-indicador"><i class="bi bi-bell-fill"></i></th>
              <th class="col-nombre">Nombre</th>
              <th class="col-fecha">Fecha</th>
              <th class="col-entrega">Entrega</th>
              <th class="col-estado">Estado</th>
              <th class="col-unidades">Unid.</th>
              <th class="col-nota">Nota</th>
              <th class="col-eliminar">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<!-- Datalist para las opciones de nota -->
<datalist id="notaEstadosDatalist">
  <option value="esperando respuesta">
  <option value="esperando cierre">
  <option value="espera cotizaci칩n">
  <option value="esperando pago">
  <option value="pago">
  <option value="retira">
  <option value="no responde">
</datalist>

<!-- Modal Dashboard -->
<div id="dashboardModal" class="dashboard-modal">
  <div class="dashboard-content">
    <div class="dashboard-header">
      <h2><i class="bi bi-bar-chart-fill"></i> Dashboard de Pedidos</h2>
      <button class="dashboard-close" onclick="cerrarDashboard()">칑</button>
    </div>
    <div class="dashboard-body">
      <!-- Filtros de Fecha -->
      <div class="dashboard-filters">
        <h3><i class="bi bi-calendar-range"></i> Filtro de Fecha</h3>
        <div class="date-filter-row">
          <div class="date-filter-group">
            <label>Desde:</label>
            <input type="date" id="dashboardFechaDesde">
          </div>
          <div class="date-filter-group">
            <label>Hasta:</label>
            <input type="date" id="dashboardFechaHasta">
          </div>
        </div>
        <button class="btn-apply-filter" onclick="actualizarDashboard()">
          <i class="bi bi-arrow-repeat"></i> Actualizar
        </button>
      </div>
      
      <!-- Estad칤sticas -->
      <div class="dashboard-stats">
        <div class="stat-card abiertos">
          <div class="stat-icon">游늭</div>
          <div class="stat-value" id="statAbiertos">0</div>
          <div class="stat-label">Pedidos Abiertos</div>
        </div>
        <div class="stat-card cerrados">
          <div class="stat-icon">游닍</div>
          <div class="stat-value" id="statCerrados">0</div>
          <div class="stat-label">Pedidos Cerrados</div>
        </div>
        <div class="stat-card totales">
          <div class="stat-icon">游늵</div>
          <div class="stat-value" id="statTotales">0</div>
          <div class="stat-label">Total de Pedidos</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Declarar variables globales y db
  const db = firebase.database();
  const tbody = document.querySelector('#tabla tbody');
  const filtroStatusBtns = document.getElementById('filtroStatusBtns');

  let pedidos = {};           // cache local para filtrar
  let allPedidos = [];        // todos los pedidos para conteo global

  // Estados posibles 
  const estados = [
    { label: 'Abierto', value: 'ABIERTO', color: '#4CAF50' },
    { label: 'Cerrado', value: 'CERRADO', color: '#4CAF50' },
    { label: 'Entrega', value: 'DESPACHADO/ENTREGADO', color: '#4CAF50' },
    { label: 'Cancel', value: 'CANCELADO', color: '#4CAF50' },
  ];

  // Por defecto seleccionados
  let statusSeleccionados = ['ABIERTO', 'CERRADO'];
  let entregaSeleccionada = null; // 'Retiro', 'Envio' o null
  let filtroClientesRecurrentes = false; // Filtro de clientes recurrentes
  let filtroMasDeUnaUnidad = false; // Filtro de pedidos con m치s de 1 unidad
  let busquedaNombre = ''; // B칰squeda por nombre
  let filtroNotaSeleccionada = ''; // Filtro por tipo de nota

  // Funci칩n para aplicar filtros (b칰squeda y nota)
  function aplicarFiltros() {
    const searchInput = document.getElementById('searchNombre');
    const filtroNotaSelect = document.getElementById('filtroNota');
    
    busquedaNombre = searchInput ? searchInput.value.toLowerCase().trim() : '';
    filtroNotaSeleccionada = filtroNotaSelect ? filtroNotaSelect.value : '';
    
    actualizarIndicadoresFiltros();
    renderTabla();
  }

  // Funci칩n para actualizar los indicadores de filtros activos
  function actualizarIndicadoresFiltros() {
    const container = document.getElementById('activeFiltersContainer');
    if (!container) return;
    
    container.innerHTML = '';
    const indicators = [];
    
    // Indicador de estado (solo si no est치n todos seleccionados)
    if (statusSeleccionados.length > 0 && statusSeleccionados.length < 4) {
      const statusText = statusSeleccionados.join(', ');
      indicators.push(`
        <div class="filter-indicator status">
          <i class="bi bi-circle-fill"></i>
          <span>Estado: ${statusText}</span>
        </div>
      `);
    }
    
    // Indicador de tipo de entrega
    if (entregaSeleccionada) {
      indicators.push(`
        <div class="filter-indicator delivery">
          <i class="bi bi-truck"></i>
          <span>${entregaSeleccionada}</span>
        </div>
      `);
    }
    
    // Indicador de clientes recurrentes
    if (filtroClientesRecurrentes) {
      indicators.push(`
        <div class="filter-indicator recurring">
          <i class="bi bi-arrow-repeat"></i>
          <span>Clientes recurrentes</span>
        </div>
      `);
    }
    
    // Indicador de m치s de 1 unidad
    if (filtroMasDeUnaUnidad) {
      indicators.push(`
        <div class="filter-indicator units">
          <i class="bi bi-box-seam"></i>
          <span>M치s de 1 unidad</span>
        </div>
      `);
    }
    
    // Indicador de b칰squeda por nombre
    if (busquedaNombre) {
      indicators.push(`
        <div class="filter-indicator search">
          <i class="bi bi-search"></i>
          <span>Buscar: "${busquedaNombre}"</span>
        </div>
      `);
    }
    
    // Indicador de filtro por nota
    if (filtroNotaSeleccionada) {
      const notaText = filtroNotaSeleccionada === 'sin_nota' ? 'Sin Nota' : filtroNotaSeleccionada;
      indicators.push(`
        <div class="filter-indicator note">
          <i class="bi bi-sticky"></i>
          <span>Nota: ${notaText}</span>
        </div>
      `);
    }
    
    container.innerHTML = indicators.join('');
  }

  // Funci칩n para inicializar el historial de pedidos despu칠s de la autenticaci칩n
  function inicializarHistorialPedidos() {
    // Si la p치gina ya est치 cargada, ejecutar inmediatamente
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', configurarEventListeners);
    } else {
      configurarEventListeners();
    }
  }

  let descargandoTodo = false;
  let listenerPedidos = null;

  function configurarEventListeners() {
    renderBotonesFiltro();
    agregarBotonDescargarTodo();
    cargarPedidosUltimos30Dias();
    configurarCierreMenuExterno();
  }

  // Funci칩n para toggle del men칰 hamburguesa
  function toggleMenu() {
    const menuDropdown = document.getElementById('menuDropdown');
    const hamburgerIcon = document.querySelector('.hamburger-icon');
    menuDropdown.classList.toggle('active');
    hamburgerIcon.classList.toggle('active');
  }

  // Cerrar men칰 al hacer clic fuera
  function configurarCierreMenuExterno() {
    document.addEventListener('click', function(event) {
      const menu = document.querySelector('.hamburger-menu');
      const menuDropdown = document.getElementById('menuDropdown');
      const hamburgerIcon = document.querySelector('.hamburger-icon');
      
      if (menu && !menu.contains(event.target) && menuDropdown.classList.contains('active')) {
        menuDropdown.classList.remove('active');
        hamburgerIcon.classList.remove('active');
      }
    });
  }

  function cargarPedidosUltimos30Dias() {
    if (listenerPedidos) listenerPedidos.off();
    descargandoTodo = false;
    const ahora = Date.now();
    const hace30dias = ahora - 30 * 24 * 60 * 60 * 1000;
    // Consulta por timestamp >= hace 30 d칤as
    listenerPedidos = db.ref('pedidos').orderByChild('timestamp').startAt(hace30dias);
    listenerPedidos.on('value', snap => {
      pedidos = [];
      allPedidos = [];
      snap.forEach(child => {
        const p = child.val() || {};
        p.id = child.key;
        pedidos.push(p);
        allPedidos.push(p);
      });
      renderTabla();
    });
  }

  function cargarPedidosTodos() {
    if (listenerPedidos) listenerPedidos.off();
    descargandoTodo = true;
    listenerPedidos = db.ref('pedidos');
    listenerPedidos.on('value', snap => {
      pedidos = [];
      allPedidos = [];
      snap.forEach(child => {
        const p = child.val() || {};
        p.id = child.key;
        pedidos.push(p);
        allPedidos.push(p);
      });
      renderTabla();
    });
  }

  // Funci칩n para contar pedidos entregados por email
  function contarPedidosEntregados(email) {
    if (!email) return 0;
    return allPedidos.filter(p => 
      p.cliente?.email?.toLowerCase() === email.toLowerCase() && 
      p.status === 'DESPACHADO/ENTREGADO'
    ).length;
  }

  // Funci칩n para verificar si un cliente es recurrente (tiene al menos 1 pedido entregado)
  function esClienteRecurrente(email) {
    if (!email) return false;
    return contarPedidosEntregados(email) > 0;
  }

  // Toggle del filtro de clientes recurrentes
  function toggleFiltroClientesRecurrentes() {
    const checkbox = document.getElementById('checkClientesRecurrentesMenu');
    filtroClientesRecurrentes = checkbox ? checkbox.checked : false;
    actualizarIndicadoresFiltros();
    renderTabla();
  }

  // Toggle del filtro de m치s de una unidad
  function toggleFiltroMasDeUnaUnidad() {
    const checkbox = document.getElementById('checkMasDeUnaUnidad');
    filtroMasDeUnaUnidad = checkbox ? checkbox.checked : false;
    actualizarIndicadoresFiltros();
    renderTabla();
  }

  // Funci칩n para limpiar todos los filtros
  function limpiarFiltros() {
    // Restablecer estados seleccionados a ABIERTO y CERRADO
    statusSeleccionados = ['ABIERTO', 'CERRADO'];
    
    // Limpiar tipo de entrega
    entregaSeleccionada = null;
    
    // Desactivar filtro de clientes recurrentes
    filtroClientesRecurrentes = false;
    const checkRecurrentes = document.getElementById('checkClientesRecurrentesMenu');
    if (checkRecurrentes) checkRecurrentes.checked = false;
    
    // Desactivar filtro de m치s de una unidad
    filtroMasDeUnaUnidad = false;
    const checkUnidades = document.getElementById('checkMasDeUnaUnidad');
    if (checkUnidades) checkUnidades.checked = false;
    
    // Limpiar b칰squeda por nombre
    busquedaNombre = '';
    const searchInput = document.getElementById('searchNombre');
    if (searchInput) searchInput.value = '';
    
    // Limpiar filtro por nota
    filtroNotaSeleccionada = '';
    const filtroNotaSelect = document.getElementById('filtroNota');
    if (filtroNotaSelect) filtroNotaSelect.value = '';
    
    // Actualizar indicadores y tabla
    actualizarIndicadoresFiltros();
    renderBotonesFiltro();
    renderTabla();
  }

  // Funciones del Dashboard
  function abrirDashboard() {
    const modal = document.getElementById('dashboardModal');
    modal.style.display = 'flex';
    
    // Establecer fechas por defecto (칰ltimos 30 d칤as)
    const hoy = new Date();
    const hace30 = new Date();
    hace30.setDate(hace30.getDate() - 30);
    
    document.getElementById('dashboardFechaHasta').valueAsDate = hoy;
    document.getElementById('dashboardFechaDesde').valueAsDate = hace30;
    
    actualizarDashboard();
  }

  function cerrarDashboard() {
    document.getElementById('dashboardModal').style.display = 'none';
  }

  function actualizarDashboard() {
    const fechaDesde = document.getElementById('dashboardFechaDesde').value;
    const fechaHasta = document.getElementById('dashboardFechaHasta').value;
    
    let pedidosFiltrados = allPedidos;
    
    // Filtrar por fecha si est치n definidas
    if (fechaDesde || fechaHasta) {
      const timestampDesde = fechaDesde ? new Date(fechaDesde).setHours(0, 0, 0, 0) : 0;
      const timestampHasta = fechaHasta ? new Date(fechaHasta).setHours(23, 59, 59, 999) : Date.now();
      
      pedidosFiltrados = allPedidos.filter(p => {
        const ts = p.timestamp || 0;
        return ts >= timestampDesde && ts <= timestampHasta;
      });
    }
    
    // Filtrar pedidos que NO tengan CREATEDBY: 'admin'
    pedidosFiltrados = pedidosFiltrados.filter(p => p.createdby !== 'admin');
    
    // Calcular estad칤sticas
    let abiertos = 0;
    let cerrados = 0;
    
    pedidosFiltrados.forEach(p => {
      if (p.status === 'ABIERTO' || (!p.status && !p.locked)) {
        abiertos++;
      } else if (p.status === 'CERRADO' || p.locked || p.status === 'DESPACHADO/ENTREGADO') {
        cerrados++;
      }
      // No contar CANCELADO como ninguno
    });
    
    const totales = abiertos + cerrados;
    
    // Actualizar UI
    document.getElementById('statAbiertos').textContent = abiertos;
    document.getElementById('statCerrados').textContent = cerrados;
    document.getElementById('statTotales').textContent = totales;
  }

  // Cerrar modal al hacer clic fuera
  document.getElementById('dashboardModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      cerrarDashboard();
    }
  });

  function agregarBotonDescargarTodo() {
    // Ya no hay bot칩n separado, la funcionalidad est치 en el men칰 hamburguesa
    // Esta funci칩n se mantiene vac칤a para no romper referencias existentes
  }

  function renderBotonesFiltro() {
    const menuFiltrosContainer = document.getElementById('menuFiltrosContainer');
    if (!menuFiltrosContainer) return;
    
    menuFiltrosContainer.innerHTML = '';
    
    // Grupo 1: Estado
    const grupo1 = document.createElement('div');
    grupo1.className = 'menu-filter-group';
    const titulo1 = document.createElement('div');
    titulo1.className = 'menu-filter-group-title';
    titulo1.textContent = 'Estado';
    grupo1.appendChild(titulo1);
    
    const botonesEstado = document.createElement('div');
    botonesEstado.className = 'menu-filter-buttons';
    
    ['Abierto', 'Cerrado', 'Entrega', 'Cancel'].forEach(label => {
      const est = estados.find(e => e.label === label);
      const btn = document.createElement('button');
      btn.className = 'menu-filter-btn';
      btn.textContent = est.label;
      btn.style.background = statusSeleccionados.includes(est.value) ? est.color : '#fff';
      btn.style.color = statusSeleccionados.includes(est.value) ? (est.textColor || '#fff') : '#333';
      btn.style.borderColor = est.color;
      btn.onclick = () => {
        if (est.value === 'ABIERTO' || est.value === 'CERRADO') {
          if (statusSeleccionados.includes(est.value)) {
            statusSeleccionados = statusSeleccionados.filter(s => s !== est.value);
          } else {
            if (statusSeleccionados.includes('ABIERTO') || statusSeleccionados.includes('CERRADO')) {
              statusSeleccionados.push(est.value);
            } else {
              statusSeleccionados = [est.value];
            }
          }
        } else {
          statusSeleccionados = [est.value];
        }
        actualizarIndicadoresFiltros();
        renderBotonesFiltro();
        renderTabla();
      };
      botonesEstado.appendChild(btn);
    });
    grupo1.appendChild(botonesEstado);
    menuFiltrosContainer.appendChild(grupo1);

    // Grupo 2: Entrega
    const grupo2 = document.createElement('div');
    grupo2.className = 'menu-filter-group';
    const titulo2 = document.createElement('div');
    titulo2.className = 'menu-filter-group-title';
    titulo2.textContent = 'Entrega';
    grupo2.appendChild(titulo2);
    
    const botonesEntrega = document.createElement('div');
    botonesEntrega.className = 'menu-filter-buttons';
    
    // Retiro
    const btnRetiro = document.createElement('button');
    btnRetiro.className = 'menu-filter-btn';
    btnRetiro.textContent = 'Retiro';
    btnRetiro.style.background = entregaSeleccionada === 'Retiro' ? '#FFD600' : '#fff';
    btnRetiro.style.color = '#333';
    btnRetiro.style.borderColor = '#FFD600';
    btnRetiro.onclick = () => {
      entregaSeleccionada = entregaSeleccionada === 'Retiro' ? null : 'Retiro';
      actualizarIndicadoresFiltros();
      renderBotonesFiltro();
      renderTabla();
    };
    botonesEntrega.appendChild(btnRetiro);

    // Envio
    const btnEnvio = document.createElement('button');
    btnEnvio.className = 'menu-filter-btn';
    btnEnvio.textContent = 'Envio';
    btnEnvio.style.background = entregaSeleccionada === 'Envio' ? '#FFD600' : '#fff';
    btnEnvio.style.color = '#333';
    btnEnvio.style.borderColor = '#FFD600';
    btnEnvio.onclick = () => {
      entregaSeleccionada = entregaSeleccionada === 'Envio' ? null : 'Envio';
      actualizarIndicadoresFiltros();
      renderBotonesFiltro();
      renderTabla();
    };
    botonesEntrega.appendChild(btnEnvio);

    // N/A
    const btnNA = document.createElement('button');
    btnNA.className = 'menu-filter-btn';
    btnNA.textContent = 'N/A';
    btnNA.style.background = entregaSeleccionada === 'N/A' ? '#FFD600' : '#fff';
    btnNA.style.color = '#333';
    btnNA.style.borderColor = '#FFD600';
    btnNA.onclick = () => {
      entregaSeleccionada = entregaSeleccionada === 'N/A' ? null : 'N/A';
      actualizarIndicadoresFiltros();
      renderBotonesFiltro();
      renderTabla();
    };
    botonesEntrega.appendChild(btnNA);

    // Todos
    const btnTodos = document.createElement('button');
    btnTodos.className = 'menu-filter-btn';
    btnTodos.textContent = 'Todos';
    btnTodos.style.background = statusSeleccionados.length === 0 && !entregaSeleccionada ? '#4CAF50' : '#fff';
    btnTodos.style.color = statusSeleccionados.length === 0 && !entregaSeleccionada ? '#fff' : '#333';
    btnTodos.style.borderColor = '#4CAF50';
    btnTodos.onclick = () => {
      statusSeleccionados = [];
      entregaSeleccionada = null;
      actualizarIndicadoresFiltros();
      renderBotonesFiltro();
      renderTabla();
    };
    botonesEntrega.appendChild(btnTodos);

    grupo2.appendChild(botonesEntrega);
    menuFiltrosContainer.appendChild(grupo2);
  }

  renderBotonesFiltro();

  function getSelectedStatuses() {
    return statusSeleccionados.length ? statusSeleccionados : null;
  }

  function getEntregaPedido(p) {
    // L칩gica extendida para N/A
    if (!p.cliente || !p.cliente.direccion || p.cliente.direccion.trim() === '') {
      return 'Retiro';
    }
    if (p.cliente.provincia === 'Gran Buenos Aires' || p.cliente.provincia === 'CABA') {
      return 'N/A';
    }
    return 'Envio';
  }

  function renderTabla() {
    actualizarIndicadoresFiltros();
    const statusSel = getSelectedStatuses();
    tbody.innerHTML = '';

    pedidos
      .filter(p => {
        // Filtrar pedidos que NO tengan CREATEDBY: 'admin'
        if (p.createdby === 'admin') return false;
        if (!statusSel) return true;
        let estado = 'ABIERTO';
        if (p.status === 'DESPACHADO/ENTREGADO') {
          estado = 'DESPACHADO/ENTREGADO';
        } else if (p.status === 'CANCELADO') {
          estado = 'CANCELADO';
        } else if (p.status === 'CERRADO' || p.locked) {
          estado = 'CERRADO';
        } else if (p.status === 'ABIERTO') {
          estado = 'ABIERTO';
        }
        return statusSel.includes(estado);
      })
      .filter(p => {
        if (!entregaSeleccionada) return true;
        // Usar el mismo valor que se muestra en la columna Entrega
        let tipoEntrega;
        const provincia = p.cliente?.provincia || '';
        if (p.tipoEntrega === 'Showroom' || !provincia) {
          tipoEntrega = 'Retiro';
        } else if (p.tipoEntrega !== 'Showroom') {
          if (provincia !== 'Gran Buenos Aires' && provincia !== 'CABA') {
            tipoEntrega = 'Envio';
          } else if (provincia === 'Gran Buenos Aires' || provincia === 'CABA') {
            tipoEntrega = 'N/A';
          } else {
            tipoEntrega = 'Envio';
          }
        } else {
          tipoEntrega = 'Retiro';
        }
        return tipoEntrega === entregaSeleccionada;
      })
      .filter(p => {
        // Filtrar por clientes recurrentes si est치 activado
        if (!filtroClientesRecurrentes) return true;
        const emailCliente = p.cliente?.email;
        return esClienteRecurrente(emailCliente);
      })
      .filter(p => {
        // Filtrar por pedidos con m치s de 1 unidad si est치 activado
        if (!filtroMasDeUnaUnidad) return true;
        let totalUnidades = 0;
        if (Array.isArray(p.items)) {
          totalUnidades = p.items.reduce((sum, item) => sum + (parseInt(item.cantidad) || 0), 0);
        }
        return totalUnidades > 1;
      })
      .filter(p => {
        // Filtrar por b칰squeda de nombre
        if (!busquedaNombre) return true;
        const nombreCliente = (p.cliente?.nombre || '').toLowerCase();
        return nombreCliente.includes(busquedaNombre);
      })
      .filter(p => {
        // Filtrar por tipo de nota
        if (!filtroNotaSeleccionada) return true;
        if (filtroNotaSeleccionada === 'sin_nota') {
          return !p.nota || p.nota.trim() === '';
        }
        return p.nota === filtroNotaSeleccionada;
      })
      .sort((a, b) => b.timestamp - a.timestamp) // m치s nuevos arriba
      .forEach(p => {
        const tr = document.createElement('tr');
        if (p.status === 'CANCELADO') tr.classList.add('cancelado-row');
        // Si el pedido est치 ABIERTO y tiene m치s de 7 d칤as, marcar en naranja
        const ahora = Date.now();
        const sieteDiasMs = 7 * 24 * 60 * 60 * 1000;
        if ((p.status === 'ABIERTO' || (!p.status && !p.locked)) && (ahora - p.timestamp > sieteDiasMs)) {
          tr.style.background = '#edb461'; // naranja
          tr.style.color = '#fff';
        }
        // Si el pedido est치 DESPACHADO/ENTREGADO, marcar en verde agua
        if (p.status === 'DESPACHADO/ENTREGADO') {
          tr.style.background = '#bbfacb'; // verde clarito
          tr.style.color = '#458254';
        }

        /* --- 1. Indicador de modificaci칩n --- */
  const indCell = tr.insertCell();
  indCell.className = 'col-indicador';
        if (p.adminViewed === false) {
          const dot = document.createElement('span');
          dot.className = 'dot';
          indCell.appendChild(dot);
        }

        /* --- 3. Nombre cliente --- */
  const nombreCell = tr.insertCell();
  nombreCell.className = 'col-nombre';
        
        // Crear contenedor vertical para nombre y badge
        const nombreContainer = document.createElement('div');
        nombreContainer.style.display = 'flex';
        nombreContainer.style.flexDirection = 'column';
        nombreContainer.style.alignItems = 'flex-start';
        nombreContainer.style.gap = '5px';
        
        const nombreSpan = document.createElement('span');
        nombreSpan.textContent = p.cliente?.nombre || '';
        nombreSpan.style.cursor = 'pointer';
        nombreSpan.style.color = '#2196F3';
        nombreSpan.style.textDecoration = 'underline';
        nombreSpan.onclick = () => {
          window.open(`pedidos.html?id=${p.id}&admin=true`, '_blank');
          db.ref(`pedidos/${p.id}`).update({ adminViewed: true })
            .catch(() => console.error('No se pudo marcar adminViewed'));
        };
        nombreContainer.appendChild(nombreSpan);
        
        // Agregar badge con contador de pedidos entregados DEBAJO del nombre
        const emailCliente = p.cliente?.email;
        if (emailCliente) {
          const cantidadEntregados = contarPedidosEntregados(emailCliente);
          if (cantidadEntregados > 0) {
            const badge = document.createElement('span');
            badge.className = 'order-count-badge';
            badge.innerHTML = `<i class="bi bi-box-seam-fill"></i>${cantidadEntregados}`;
            badge.title = `${cantidadEntregados} pedido(s) entregado(s)`;
            badge.style.marginTop = '5px';
            nombreContainer.appendChild(badge);
          }
        }
        
        nombreCell.appendChild(nombreContainer);

        /* --- 4. Fecha corta --- */
        const fecha = new Date(p.timestamp);
        const fechaCell = tr.insertCell();
        fechaCell.className = 'col-fecha';
        fechaCell.textContent =
          fecha.toLocaleDateString('es-AR') + ' ' +
          fecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });


        /* --- 6. ENTREGA --- */
        let tipoEntrega = '';
        const provincia = p.cliente?.provincia ? p.cliente.provincia.trim() : '';
        if (p.tipoEntrega === 'Showroom') {
          tipoEntrega = 'Retiro';
        } else if (!provincia) {
          tipoEntrega = 'Retiro';
        } else if (p.tipoEntrega !== 'Showroom') {
          if (provincia !== 'Gran Buenos Aires' && provincia !== 'CABA') {
            tipoEntrega = 'Envio';
          } else if (provincia === 'Gran Buenos Aires' || provincia === 'CABA') {
            tipoEntrega = 'N/A';
          } else {
            tipoEntrega = 'Envio';
          }
        } else {
          tipoEntrega = 'Retiro';
        }
  const entregaCell = tr.insertCell();
  entregaCell.className = 'col-entrega';
  entregaCell.textContent = tipoEntrega;

        /* --- 7. Estado --- */
        let estado = 'ABIERTO';
        if (p.status === 'DESPACHADO/ENTREGADO') {
          estado = 'DESPACHADO/ENTREGADO';
        } else if (p.status === 'CANCELADO') {
          estado = 'CANCELADO';
        } else if (p.status === 'CERRADO' || p.locked) {
          estado = 'CERRADO';
        } else if (p.status === 'ABIERTO') {
          estado = 'ABIERTO';
        }
  const estadoCell = tr.insertCell();
  estadoCell.className = 'col-estado';
  estadoCell.textContent = estado;

  /* --- Unidades totales --- */
  const unidadesCell = tr.insertCell();
  unidadesCell.className = 'col-unidades';
  let totalUnidades = 0;
  if (Array.isArray(p.items)) {
    totalUnidades = p.items.reduce((sum, item) => sum + (parseInt(item.cantidad) || 0), 0);
  }
  unidadesCell.textContent = totalUnidades;

        /* --- 8. Nota --- */
        const notaCell = tr.insertCell();
        notaCell.className = 'col-nota';
        // Contenedor para nota y fecha
        const notaCont = document.createElement('div');
        notaCont.style.display = 'flex';
        notaCont.style.flexDirection = 'column';
        notaCont.style.alignItems = 'stretch';
        notaCont.style.gap = '0.25rem';

        // Crear select en lugar de input con datalist
        const notaSelect = document.createElement('select');
        notaSelect.className = 'nota-input';
        notaSelect.style.cursor = 'pointer';
        
        // Opciones del select
        const opcionesNota = [
          { value: '', label: '---' },
          { value: 'esperando respuesta', label: 'Esperando respuesta' },
          { value: 'esperando cierre', label: 'Esperando cierre' },
          { value: 'espera cotizaci칩n', label: 'Espera cotizaci칩n' },
          { value: 'esperando pago', label: 'Esperando pago' },
          { value: 'pago', label: 'Pago' },
          { value: 'retira', label: 'Retira' },
          { value: 'no responde', label: 'No responde' },
          { value: 'no cumple minimo', label: 'No cumple minimo' },
          { value: '???', label: '???' },
        ];
        
        // Agregar opciones al select
        opcionesNota.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if (p.nota === opt.value) {
            option.selected = true;
          }
          notaSelect.appendChild(option);
        });


        // Fecha y hora de 칰ltima actualizaci칩n
        const notaFecha = p.notaFecha ? new Date(p.notaFecha) : null;
        const fechaLabel = document.createElement('span');
        fechaLabel.style.fontSize = '0.7rem';
        fechaLabel.style.color = '#999';
        fechaLabel.style.fontStyle = 'italic';
        fechaLabel.style.textAlign = 'left';
        fechaLabel.textContent = (notaFecha && (p.nota && p.nota.trim() !== ''))
          ? `Actualizaci칩n: ${notaFecha.toLocaleDateString('es-AR')} ${notaFecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`
          : '';

        function actualizarNota(nuevaNota) {
          const ahora = Date.now();
          db.ref(`pedidos/${p.id}`).update({ nota: nuevaNota, notaFecha: ahora })
            .then(() => {
              const fechaHora = new Date(ahora);
              fechaLabel.textContent = (nuevaNota && nuevaNota.trim() !== '')
                ? `Actualizaci칩n: ${fechaHora.toLocaleDateString('es-AR')} ${fechaHora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`
                : '';
            })
            .catch(() => console.error('Error al guardar la nota'));
        }

        // Cambio inmediato al seleccionar
        notaSelect.addEventListener('change', function() {
          actualizarNota(this.value);
        });

        notaCont.appendChild(notaSelect);
        notaCont.appendChild(fechaLabel);
        notaCell.appendChild(notaCont);

        /* --- 9. Acciones (llamada, compartir y eliminar) --- */
        const acciones = tr.insertCell();
        acciones.className = 'col-eliminar';
        
        // Contenedor flex para los botones
        const botonesContainer = document.createElement('div');
        botonesContainer.style.display = 'flex';
        botonesContainer.style.gap = '0.5rem';
        botonesContainer.style.justifyContent = 'center';
        botonesContainer.style.alignItems = 'center';
        botonesContainer.style.flexWrap = 'nowrap';
        
        // Bot칩n Llamar/WhatsApp
        const telefono = p.cliente?.telefono ? p.cliente.telefono.replace(/[^\d]/g, '') : '';
        let telClean = telefono;
        if (telClean.startsWith('0')) telClean = telClean.substring(1);
        if (telClean && !telClean.startsWith('54')) telClean = '54' + telClean;
        const btnTel = document.createElement('button');
        btnTel.innerHTML = '<i class="bi bi-whatsapp"></i>';
        btnTel.title = 'WhatsApp';
        btnTel.className = 'btn-icon btn-whatsapp';
        btnTel.disabled = !telClean;
        btnTel.onclick = () => {
          if (telClean) {
            window.open(`https://api.whatsapp.com/send/?phone=${telClean}`, '_blank');
          }
        };
        botonesContainer.appendChild(btnTel);
        
        // Bot칩n Copiar URL
        const btnCopiar = document.createElement('button');
        btnCopiar.innerHTML = '<i class="bi bi-link-45deg"></i>';
        btnCopiar.title = 'Copiar enlace';
        btnCopiar.className = 'btn-icon btn-copy';
        btnCopiar.onclick = () => {
          const urlBase = window.location.origin + '/pedidos.html?id=' + p.id;
          navigator.clipboard.writeText(urlBase).then(() => {
            btnCopiar.innerHTML = '<i class="bi bi-check-lg"></i>';
            setTimeout(() => {
              btnCopiar.innerHTML = '<i class="bi bi-link-45deg"></i>';
            }, 2000);
          }).catch(err => {
            alert('No se pudo copiar la URL');
            console.error('Error al copiar:', err);
          });
        };
        botonesContainer.appendChild(btnCopiar);
        
        // Bot칩n Eliminar
        const btnEliminar = document.createElement('button');
        btnEliminar.innerHTML = '<i class="bi bi-trash-fill"></i>';
        btnEliminar.title = 'Eliminar';
        btnEliminar.className = 'btn-icon btn-delete';
        btnEliminar.onclick = () => {
          mostrarModalClave(() => {
            if (confirm('쮼st치 seguro que desea eliminar este pedido? Esta acci칩n es irreversible.')) {
              db.ref(`pedidos/${p.id}`).remove()
                .catch(()=>alert('Error al eliminar el pedido'));
            }
          });
        };
        botonesContainer.appendChild(btnEliminar);
        
        acciones.appendChild(botonesContainer);

        tbody.appendChild(tr);
      });
}


</script>

<!-- Modal de autorizaci칩n reutilizable -->
<div id="modalClave" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:2rem;border-radius:16px;min-width:280px;max-width:90vw;box-shadow:0 8px 32px rgba(0,0,0,0.2);text-align:center;animation:fadeInUp 0.3s ease-out;">
    <div style="font-size:1.2rem;margin-bottom:1rem;font-weight:600;color:#212121;">
      <i class="bi bi-shield-lock-fill" style="color:#4CAF50;font-size:2rem;display:block;margin-bottom:0.5rem;"></i>
      C칩digo de autorizaci칩n
    </div>
    <input id="inputClave" type="password" style="width:180px;padding:0.75rem;font-size:1.1rem;margin-bottom:1.5rem;border:2px solid #e0e0e0;border-radius:8px;text-align:center;letter-spacing:2px;font-weight:bold;" maxlength="8" autocomplete="off" placeholder="뮉뮉뮉뮉뮉" autofocus>
    <br>
    <div style="display:flex;gap:0.75rem;justify-content:center;">
      <button id="btnOkClave" style="background:#4CAF50;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;font-weight:600;flex:1;max-width:120px;">Confirmar</button>
      <button id="btnCancelClave" style="background:#757575;color:#fff;padding:0.75rem 1.5rem;border-radius:8px;font-weight:600;flex:1;max-width:120px;">Cancelar</button>
    </div>
  </div>
</div>

<script>
function mostrarModalClave(onSuccess) {
  const modal = document.getElementById('modalClave');
  const input = document.getElementById('inputClave');
  const btnOk = document.getElementById('btnOkClave');
  const btnCancel = document.getElementById('btnCancelClave');
  input.value = '';
  modal.style.display = 'flex';
  input.focus();
  btnOk.onclick = () => {
    if (input.value === 'Q') {
      modal.style.display = 'none';
      onSuccess();
    } else {
      alert('C칩digo incorrecto. No se eliminar치 el pedido.');
      input.value = '';
      input.focus();
    }
  };
  btnCancel.onclick = () => { modal.style.display = 'none'; };
  input.onkeydown = e => { if (e.key === 'Enter') btnOk.onclick(); };
}
</script>

</body>
</html>