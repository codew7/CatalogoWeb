<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Detalle de pedido.">
  <title>Pedido | HomePoint</title>
  <link rel="icon" href="faviconnegro.png" type="image/png">

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

  <script>
    let pedidoActual = null;
    let sheetValorMap = {}; // Mapa para valorC y valorU por c√≥digo
    let sheetCategoryMap = {}; // Mapa para categor√≠a por c√≥digo

    // Lista de emails de administradores
    const adminEmails = ["distribuidorahomepoint@gmail.com"];

    firebase.auth().onAuthStateChanged(user => {
      if (user && adminEmails.includes(user.email)) {
        admin = true;
        if (!location.search.includes('admin=true')) {
          const url = new URL(window.location.href);
          url.searchParams.set('admin', 'true');
          window.location.replace(url.toString());
          return;
        }
      } else {
        admin = false;
      }
      // Mostrar bot√≥n "Hablar con alguien" solo para usuarios no administradores
      const hablarBtn = document.getElementById('hablarBtn');
      if (hablarBtn) {
        if (!admin) {
          hablarBtn.style.display = 'inline-block';
          hablarBtn.onclick = function() {
            const pedidoId = id;
            const mensaje = encodeURIComponent(`Hola! Me contacto por mi pedido: https://www.home-point.com.ar/pedidos.html?id=${pedidoId}`);
            window.open(`https://api.whatsapp.com/send/?phone=5491121891006&text=${mensaje}`, '_blank');
          };
        } else {
          hablarBtn.style.display = 'none';
        }
      }
      // Cargar datos de Google Sheets al inicializar
      cargarDatosSheets();
    });
</script>


  <style>
    body{
      font-family:Arial,Helvetica,sans-serif;
      padding:6px;
      background:#f1f1f1;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
    }
    h1{color:#4CAF50;text-align:center;;margin-bottom:10px}
    #items {
      max-width: 750px;
      width: 100%;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-sizing: border-box;
      display: block;
      overflow-x: auto;
    }
    #items table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      margin-bottom: 10px;
      overflow-x: auto;
      display: block;
    }
    #items div { display: flex; justify-content: space-between; margin-bottom: 5px; }
    #items input { width: 60px; text-align: center; }

    @media (max-width: 600px) {
      #items {
        padding: 8px;
        border-radius: 0;
        box-shadow: none;
        min-width: 0;
        max-width: 100vw;
      }
      #items table {
        font-size: 0.95em;
        min-width: 320px;
        width: 100%;
        display: block;
        overflow-x: auto;
      }
      th, td {
        padding: 6px 2px;
        font-size: 0.95em;
      }
    }
    button, .accion-btn {
      background:#4CAF50;
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:4px;
      cursor:pointer;
      margin:5px;
      min-width:160px;
      max-width:200px;
      font-size:1em;
      box-sizing:border-box;
      text-align:center;
      transition:background 0.2s, color 0.2s, opacity 0.2s;
    }
    button:disabled, .accion-btn:disabled{background:#9e9e9e;cursor:not-allowed;}
    #imprimirRotuloBtn {
      min-width:160px;
      max-width:200px;
      font-size:1em;
      box-sizing:border-box;
      text-align:center;
    }
    #imprimirRotuloBtn { background: #222 !important; }
    #imprimirRotuloBtn[disabled] { background: #9e9e9e !important; }
    #mensajeBtn { background: #25D366 !important; }
    #mensajeBtn[disabled] { background: #9e9e9e !important; }
    #despachadoEntregadoBtn { background: #222 !important; }
    #despachadoEntregadoBtn[disabled] { background: #9e9e9e !important; }
    #accionesAdmin {
      text-align: center;
      margin-top: 10px;
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 5px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin:5px auto;
      background:#fff;
      font-size: small;
    }
    th,td{padding:8px;border:1px solid #ddd;text-align:center}
    th{background:#4CAF50;color:#fff}
    #total{font-weight:bold;font-size:1.1em;margin-top:10px;text-align:center}
    #estado{font-weight:bold;text-align:center;margin:20px 0}
    #total {text-align:center;font-weight:bold;font-size:1.1em;margin-top:15px}
    th.cant,td.cant{width:1%;white-space:nowrap;min-width:40px;}
    th.elim,td.elim{width:1%;min-width:28px;padding-left:0;padding-right:0;}
    .eliminar-articulo{background:#e53935 !important;color:#fff !important;font-size:0.9em;padding:2px 7px 2px 7px;margin:0;line-height:1;min-width:22px;min-height:22px;border-radius:50%;}
    
    .stock-disponible {
      font-weight: bold;
      text-align: center;
    }
    .stock-ok { color: #4CAF50; }
    .stock-bajo { color: #ff9800; }
    .stock-sin { color: #e53935; }
    .stock-loading { color: #666; }

    .lightbox {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,.8);
      z-index: 4000;
      width: 100vw;
      height: 100vh;
    }
    .lightbox img {
      max-width: 50vw;
      max-height: 50vh;
      display: block;
      margin: auto;
      position: relative;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    .lightbox .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 2rem;
      color: #fff;
      cursor: pointer;
    }

    button#cancelarBtn {
      background: #e53935 !important;
    }
    button.eliminar-articulo {
      background: #e53935 !important;
      color: #fff !important;
    }

    .accion-btn, #accionesAdmin button {
      min-width: 160px;
      max-width: 160px;
      width: 160px;
      height: 44px;
      font-size: 1em;
      box-sizing: border-box;
      margin: 5px;
      text-align: center;
      display: inline-block;
    }

    .acciones-botones, #accionesAdmin, .accion-btn-contenedor {
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 0 auto;
    }

    .acciones-botones button, #accionesAdmin button, .accion-btn-contenedor button, .accion-btn {
      flex: 1 1 160px;
      max-width: 16px;
      min-width: 160px;
      margin: 5px;
      box-sizing: border-box;
    }

    /* Estilos para el mensaje de carga */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 1.2em;
      color: #333;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .loading-subtext {
      font-size: 0.9em;
      color: #666;
      text-align: center;
      max-width: 300px;
      line-height: 1.4;
    }

    /* Estilos para el dropdown de mensajes */
    #mensajeDropdown a:hover {
      background-color: #f1f1f1;
    }

  </style>
</head>
<body>
  <!-- Mensaje de carga -->
  <div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Cargando pedido...</div>
    <div class="loading-subtext">Por favor, espere mientras se cargan los datos del pedido</div>
  </div>

  <h1>Detalle del pedido</h1>
  <div id="fechaIngreso" style="text-align:center;color:#666;font-size:0.95em;margin-bottom:10px"></div>
  <div id="nombreCliente" style="text-align:center;font-weight:bold;font-size:1.1em;margin-bottom:5px;cursor:pointer;" title="Click para copiar"></div>
  <div id="direccionCliente" style="text-align:center;margin-bottom:5px"></div>
  <div id="localidadCliente" style="text-align:center;margin-bottom:5px"></div>
  <div id="provinciaCliente" style="text-align:center;margin-bottom:5px"></div>
  <div id="dniCliente" style="text-align:center;margin-bottom:5px"></div>
  <div id="telefonoCliente" style="text-align:center;margin-bottom:5px"></div>
  <div id="emailCliente" style="text-align:center;margin-bottom:5px;cursor:pointer;" title="Click para copiar"></div>
  <div style="display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:5px;">
    <button id="editarClienteBtn" style="background:#2196F3;">Editar datos personales</button>
    <div id="estado" style="font-weight:bold;"></div>
  </div>

  <div id="items"></div>

  <div style="text-align:center;margin-top:20px;">
  <button id="agregarItemBtn" class="accion-btn">Agregar Art√≠culos</button>
  <button id="guardarBtn" class="accion-btn">Guardar Cambios</button>
  <button id="toggleEstadoBtn" class="accion-btn">Cerrar Pedido</button>
  <button id="cancelarBtn" class="accion-btn">Cancelar Pedido</button>
  <button id="hablarBtn" class="accion-btn" style="background:#2196F3;display:none;">Chat</button>
  <button id="ImprimirBtn" class="accion-btn" style="display:none;background:#888;">Imprimir</button>

  </div>
  <div id="accionesAdmin" style="text-align:left;margin-top:10px;">
    <div id="mensajeBtnContainer" style="display:none;position:relative;">
      <button id="mensajeBtn" class="accion-btn" style="background:#25D366;">Mensaje R√°pido ‚ñº</button>
      <div id="mensajeDropdown" style="display:none;position:absolute;background-color:#fff;min-width:200px;box-shadow:0px 8px 16px 0px rgba(0,0,0,0.2);z-index:1;border-radius:4px;overflow:hidden;left:50%;transform:translateX(-50%);margin-top:2px;">
        <a href="#" data-mensaje="1" style="color:#333;padding:12px 16px;text-decoration:none;display:block;border-bottom:1px solid #eee;">üí¨ Retirar Pedido</a>
        <a href="#" data-mensaje="2" style="color:#333;padding:12px 16px;text-decoration:none;display:block;border-bottom:1px solid #eee;">üí¨ Saludo Inicial</a>
        <a href="#" data-mensaje="3" style="color:#333;padding:12px 16px;text-decoration:none;display:block;">üí¨ Mensaje 3</a>
      </div>
    </div>
    <button id="despachadoEntregadoBtn" class="accion-btn" style="display:none;background:#666;">Entregado</button>
  </div>

  <div id="imgLightbox" class="lightbox" onclick="cerrarLB(event)">
  <span class="close" onclick="cerrarLB(event)">√ó</span>
  <img id="lbImg" src="" alt="">
</div>

<!-- Datalist para autocompletar ALIAS -->
<datalist id="aliasDatalist">
</datalist>

<script>
let admin = false; // Declarar admin al principio para evitar errores de hoisting

  const qs    = new URLSearchParams(location.search);
  const id    = qs.get('id');

  if (!id){ document.body.innerHTML = "<p>ID inv√°lido</p>"; throw 'no-id'; }

  const pedidoRef = db.ref('pedidos/'+id);

  // === ALIAS: Variables y funciones ===
  let aliasHistorial = [];

  // Cargar historial de alias desde Firebase (optimizado: 50 en lugar de 200)
  function cargarHistorialAlias() {
    db.ref('pedidos').orderByChild('timestamp').limitToLast(50).once('value').then(snap => {
      const aliasSet = new Set(); // Para evitar duplicados
      const aliasTemp = [];
      
      // Extraer solo los alias (sin cargar todos los datos del pedido)
      snap.forEach(child => {
        const pagos = child.val()?.pagos;
        if (pagos?.alias && pagos.alias.trim() !== '') {
          const alias = pagos.alias.trim().toUpperCase();
          if (!aliasSet.has(alias) && aliasSet.size < 10) {
            aliasSet.add(alias);
            aliasTemp.push({
              alias: alias,
              timestamp: child.val().timestamp || 0
            });
          }
        }
      });
      
      // Ordenar por timestamp descendente
      aliasHistorial = aliasTemp
        .sort((a, b) => b.timestamp - a.timestamp)
        .map(item => item.alias)
        .slice(0, 10);
      
      // Actualizar datalist
      actualizarDatalistAlias();
    }).catch(err => {
      console.error('Error cargando historial de alias:', err);
    });
  }

  // Funci√≥n para actualizar el datalist de alias
  function actualizarDatalistAlias() {
    const datalistAlias = document.getElementById('aliasDatalist');
    if (!datalistAlias) return;
    
    datalistAlias.innerHTML = '';
    aliasHistorial.forEach(alias => {
      const option = document.createElement('option');
      option.value = alias;
      datalistAlias.appendChild(option);
    });
  }

  // Funci√≥n para mostrar/ocultar el campo ALIAS
  function actualizarVisibilidadAlias() {
    const aliasRow = document.getElementById('aliasRow');
    const tipoPago = document.querySelector('input[name="tipoPago"]:checked');
    
    if (aliasRow) {
      // Solo mostrar si es admin, est√° seleccionada Transferencia y Firebase est√° autenticado
      const user = firebase.auth().currentUser;
      if (admin && user && tipoPago && tipoPago.value === 'Transferencia') {
        aliasRow.style.display = 'block';
      } else {
        aliasRow.style.display = 'none';
      }
    }
  }

  // Sistema de batch updates para reducir escrituras a Firebase
  let updateQueue = {};
  let updateTimer = null;

  function programarActualizacion(path, data) {
    // Acumular cambios
    if (!updateQueue[path]) updateQueue[path] = {};
    updateQueue[path] = { ...updateQueue[path], ...data };
    
    // Cancelar timer anterior
    if (updateTimer) clearTimeout(updateTimer);
    
    // Guardar despu√©s de 2 segundos sin cambios (optimizado de 800ms)
    updateTimer = setTimeout(() => {
      const promises = Object.entries(updateQueue).map(([path, data]) => 
        firebase.database().ref(path).update(data)
      );
      
      Promise.all(promises)
        .then(() => {
          updateQueue = {};
          console.log('Cambios guardados autom√°ticamente');
        })
        .catch(err => console.error('Error guardando cambios:', err));
    }, 2000);
  }

  // Funci√≥n para convertir ALIAS a may√∫sculas en tiempo real y guardar autom√°ticamente
  function configurarCampoAlias() {
    const aliasInput = document.getElementById('alias');
    if (aliasInput) {
      aliasInput.addEventListener('input', function() {
        // Guardar la posici√≥n del cursor
        const start = this.selectionStart;
        const end = this.selectionEnd;
        // Convertir a may√∫sculas
        this.value = this.value.toUpperCase();
        // Restaurar la posici√≥n del cursor
        this.setSelectionRange(start, end);
        
        // Programar actualizaci√≥n en lote
        programarActualizacion(
          `pedidos/${pedidoActual.id}/pagos`,
          { alias: this.value.trim() }
        );
      });
    }
  }

  // Funci√≥n para guardar autom√°ticamente el tipo de pago (usando batch updates)
  function guardarTipoPago() {
    const tipoPago = document.querySelector('input[name="tipoPago"]:checked');
    if (tipoPago && pedidoActual && pedidoActual.id) {
      programarActualizacion(
        `pedidos/${pedidoActual.id}`,
        { tipoPago: tipoPago.value }
      );
    }
  }

  // Funci√≥n para guardar autom√°ticamente el tipo de entrega (usando batch updates)
  function guardarTipoEntrega() {
    const tipoEntrega = document.querySelector('input[name="tipoEntrega"]:checked');
    if (tipoEntrega && pedidoActual && pedidoActual.id) {
      // Calcular campo entrega
      let entrega = '';
      if (tipoEntrega.value && tipoEntrega.value !== 'Retiro en local') {
        entrega = 'Envios';
      }
      
      programarActualizacion(
        `pedidos/${pedidoActual.id}`,
        { tipoEntrega: tipoEntrega.value, entrega: entrega }
      );
    }
  }

  // Cargar historial de alias al inicializar
  cargarHistorialAlias();

  // Variable para almacenar la funci√≥n del listener
  let listenerActivo = null;

  // Funci√≥n para cargar el pedido inicialmente
  async function cargarPedidoInicial() {
    const snap = await pedidoRef.once('value');
    pedidoActual = snap.val();
    
    if (!pedidoActual){
      // Ocultar mensaje de carga antes de mostrar error
      const loadingOverlay = document.getElementById('loadingOverlay');
      if (loadingOverlay) loadingOverlay.style.display = 'none';
      
      document.body.innerHTML = "<p>Pedido no encontrado</p>";
      return;
    }
    
    // === NUEVO: status por defecto ===
    if (!pedidoActual.status) {
      await pedidoRef.update({ status: 'ABIERTO' });
      pedidoActual.status = 'ABIERTO';
    }

    // Procesar el pedido
    procesarPedidoCargado();
    
    // Solo activar listener en tiempo real si el pedido est√° abierto y no despachado/cancelado
    if (!pedidoActual.locked && 
        pedidoActual.status !== 'DESPACHADO/ENTREGADO' && 
        pedidoActual.status !== 'CANCELADO') {
      activarListenerTiempoReal();
    }
  }

  // Funci√≥n para activar listener en tiempo real (solo para pedidos abiertos)
  function activarListenerTiempoReal() {
    if (listenerActivo) return; // Ya est√° activo
    
    listenerActivo = (snap) => {
      const pedidoNuevo = snap.val();
      if (!pedidoNuevo) return;
      
      // Solo actualizar si hay cambios relevantes
      const cambiosRelevantes = 
        JSON.stringify(pedidoNuevo.items) !== JSON.stringify(pedidoActual.items) ||
        pedidoNuevo.status !== pedidoActual.status ||
        pedidoNuevo.locked !== pedidoActual.locked;
      
      if (cambiosRelevantes) {
        pedidoActual = pedidoNuevo;
        procesarPedidoCargado();
      }
      
      // Desactivar listener si el pedido se cierra o despacha
      if (pedidoNuevo.locked || 
          pedidoNuevo.status === 'DESPACHADO/ENTREGADO' || 
          pedidoNuevo.status === 'CANCELADO') {
        desactivarListenerTiempoReal();
      }
    };
    
    pedidoRef.on('value', listenerActivo);
    console.log('Listener en tiempo real activado');
  }

  // Funci√≥n para desactivar listener en tiempo real
  function desactivarListenerTiempoReal() {
    if (listenerActivo) {
      pedidoRef.off('value', listenerActivo);
      listenerActivo = null;
      console.log('Listener en tiempo real desactivado');
    }
  }

  // Funci√≥n que procesa el pedido cargado (c√≥digo original del .on('value'))
  function procesarPedidoCargado() {
    if (!pedidoActual) return;

    // Actualizar valorC y valorU de los items desde Google Sheets
    actualizarValoresItems();

    // Mostrar datos del cliente
    const cliente = pedidoActual.cliente || {};
    document.getElementById('nombreCliente').textContent = cliente.nombre || '';
    document.getElementById('direccionCliente').textContent = cliente.direccion || '';
    document.getElementById('localidadCliente').textContent = cliente.localidad || '';
    document.getElementById('provinciaCliente').textContent = cliente.provincia || '';
    document.getElementById('dniCliente').textContent = cliente.dni ? `DNI: ${cliente.dni}` : '';
    if (cliente.telefono) {
      // Formatear el tel√©fono para WhatsApp (eliminar espacios, guiones, par√©ntesis)
      let telClean = cliente.telefono.replace(/[^\d]/g, '');
      // Si empieza con 0, quitarlo
      if (telClean.startsWith('0')) telClean = telClean.substring(1);
      // Si no empieza con 54, agregarlo
      if (!telClean.startsWith('54')) telClean = '54' + telClean;
      document.getElementById('telefonoCliente').innerHTML = `Tel√©fono: <a href='https://api.whatsapp.com/send/?phone=${telClean}' target='_blank' style='color:#4CAF50;text-decoration:underline;'>${cliente.telefono}</a>`;
    } else {
      document.getElementById('telefonoCliente').textContent = '';
    }
    document.getElementById('emailCliente').textContent = cliente.email ? `${cliente.email}` : 'Email no disponible';
    
    // Configurar funcionalidad de copiar al portapapeles para nombre y email
    const nombreEl = document.getElementById('nombreCliente');
    const emailEl = document.getElementById('emailCliente');
    
    if (nombreEl && cliente.nombre) {
      nombreEl.onclick = function() {
        navigator.clipboard.writeText(cliente.nombre).then(() => {
          const textoOriginal = this.textContent;
          this.textContent = '‚úì Copiado!';
          this.style.color = '#4CAF50';
          setTimeout(() => {
            this.textContent = textoOriginal;
            this.style.color = '';
          }, 1500);
        }).catch(() => console.error('Error al copiar al portapapeles'));
      };
    }
    
    if (emailEl && cliente.email) {
      emailEl.onclick = function() {
        navigator.clipboard.writeText(cliente.email).then(() => {
          const textoOriginal = this.textContent;
          this.textContent = '‚úì Copiado!';
          this.style.color = '#4CAF50';
          setTimeout(() => {
            this.textContent = textoOriginal;
            this.style.color = '';
          }, 1500);
        }).catch(() => console.error('Error al copiar al portapapeles'));
      };
    }

    // Configurar copiar al portapapeles para direccion y localidad (copiar ambos como "direccion, localidad")
    const direccionEl = document.getElementById('direccionCliente');
    const localidadEl = document.getElementById('localidadCliente');

    function copyDireccionLocalidadHandler() {
      const parts = [];
      if (cliente.direccion) parts.push(cliente.direccion);
      if (cliente.localidad) parts.push(cliente.localidad);
      const textToCopy = parts.join(', ');
      if (!textToCopy) return;
      navigator.clipboard.writeText(textToCopy).then(() => {
        const textoOriginal = this.textContent;
        this.textContent = '‚úì Copiado!';
        this.style.color = '#4CAF50';
        setTimeout(() => {
          this.textContent = textoOriginal;
          this.style.color = '';
        }, 1500);
      }).catch(() => console.error('Error al copiar al portapapeles'));
    }

    if (direccionEl) {
      direccionEl.style.cursor = 'pointer';
      direccionEl.title = 'Click para copiar direcci√≥n y localidad';
      direccionEl.onclick = copyDireccionLocalidadHandler;
    }

    if (localidadEl) {
      localidadEl.style.cursor = 'pointer';
      localidadEl.title = 'Click para copiar direcci√≥n y localidad';
      localidadEl.onclick = copyDireccionLocalidadHandler;
    }
    
    // Mostrar fecha y hora de ingreso
    let fechaIngreso = '';
    if (pedidoActual.timestamp) {
      const d = new Date(pedidoActual.timestamp);
      fechaIngreso = d.toLocaleString('es-AR');
    } else if (!isNaN(Number(pedidoActual.id)) && Number(pedidoActual.id) > 1000000000000) {
      const d = new Date(Number(pedidoActual.id));
      fechaIngreso = d.toLocaleString('es-AR');
    }
    document.getElementById('fechaIngreso').textContent = fechaIngreso ? `${fechaIngreso}` : '';

    // Mostrar bot√≥n Imprimir R√≥tulo solo para admin
    if (admin) {
      // === Bot√≥n Imprimir y Despachado/Entregado ===
      const ImprimirBtn = document.getElementById('ImprimirBtn');
      const despachadoEntregadoBtn = document.getElementById('despachadoEntregadoBtn');
      const mensajeBtn = document.getElementById('mensajeBtn');
      const mensajeBtnContainer = document.getElementById('mensajeBtnContainer');
      const mensajeDropdown = document.getElementById('mensajeDropdown');
      ImprimirBtn.style.display = 'inline-block';
      despachadoEntregadoBtn.style.display = 'inline-block';
      mensajeBtnContainer.style.display = 'inline-block';
      // Mover el bot√≥n ImprimirBtn al bloque de acciones admin
      const accionesAdmin = document.getElementById('accionesAdmin');
      if (accionesAdmin && ImprimirBtn) {
        accionesAdmin.insertBefore(ImprimirBtn, accionesAdmin.firstChild);
      }
      // El bot√≥n Despachado/Entregado queda a la derecha (ya est√° en el HTML)

      // === Bot√≥n Mensaje WhatsApp con Dropdown ===
      // Toggle dropdown al hacer click en el bot√≥n
      mensajeBtn.onclick = (e) => {
        e.stopPropagation();
        mensajeDropdown.style.display = mensajeDropdown.style.display === 'block' ? 'none' : 'block';
      };

      // Cerrar dropdown al hacer click fuera
      window.addEventListener('click', () => {
        mensajeDropdown.style.display = 'none';
      });

      // Manejar clicks en las opciones del dropdown
      document.querySelectorAll('#mensajeDropdown a').forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          const tipoMensaje = e.target.getAttribute('data-mensaje');
          enviarMensajeWhatsApp(tipoMensaje);
          mensajeDropdown.style.display = 'none';
        };
      });

      // Funci√≥n para enviar mensaje de WhatsApp seg√∫n el tipo
      function enviarMensajeWhatsApp(tipo) {
        if (!pedidoActual || !pedidoActual.cliente) {
          alert('No se encontr√≥ informaci√≥n del cliente');
          return;
        }
        
        const cliente = pedidoActual.cliente;
        const nombreCliente = cliente.nombre || 'Cliente';
        const telefono = cliente.telefono;
        
        if (!telefono) {
          alert('El cliente no tiene un tel√©fono registrado');
          return;
        }
        
        // Formatear el tel√©fono para WhatsApp (eliminar espacios, guiones, par√©ntesis)
        let telClean = telefono.replace(/[^\d]/g, '');
        // Si empieza con 0, quitarlo
        if (telClean.startsWith('0')) telClean = telClean.substring(1);
        // Si no empieza con 54, agregarlo
        if (!telClean.startsWith('54')) telClean = '54' + telClean;
        
        // Construir el enlace del pedido
        const pedidoLink = `https://www.home-point.com.ar/pedidos.html?id=${id}`;
        
        // Construir el mensaje seg√∫n el tipo seleccionado
        let mensaje = '';
        
        if (tipo === '1') {
          // Mensaje Rapido 1
          mensaje = `Hola, ${nombreCliente}:
El art√≠culo solicitado en tu pedido se encuentra disponible.
Pod√©s retirarlo en nuestro showroom, ubicado en Sargento Cabral 1945, Florida Oeste (Vicente L√≥pez).
Nuestro horario de atenci√≥n es de lunes a viernes de 9 a 18 hs y s√°bados de 10 a 17 hs.

Adjuntamos el enlace que te llevar√° a tu pedido. Esperamos tu confirmaci√≥n.

Distribuidora Home Point.-

${pedidoLink}`;
        } else if (tipo === '2') {
          // Mensaje Rapido 2
          mensaje = `Hola, ${nombreCliente}:

Nos comunicamos desde Distribuidora HomePoint en relaci√≥n a tu pedido.

Adjuntamos el enlace a tu pedido:
${pedidoLink}`;

        } else if (tipo === '3') {
          // Mensaje Rapido 3
          mensaje = `Hola, ${nombreCliente}:

Te contactamos de Distribuidora Home Point.

[Escribe aqu√≠ tu segundo mensaje personalizado]

Link a tu pedido:
${pedidoLink}

Saludos cordiales.

Distribuidora Home Point.-`;
        }
        
        // Codificar el mensaje para URL
        const mensajeEncoded = encodeURIComponent(mensaje);
        
        // Abrir WhatsApp con el mensaje
        window.open(`https://api.whatsapp.com/send/?phone=${telClean}&text=${mensajeEncoded}`, '_blank');
      }

      // Estado visual del bot√≥n
      function actualizarBotonDespachado() {
        despachadoEntregadoBtn.textContent = 'Entregado';
        despachadoEntregadoBtn.style.background = '#666';
        // Solo habilitado si el status NO es DESPACHADO/ENTREGADO ni CANCELADO
        despachadoEntregadoBtn.disabled = pedidoActual.status === 'DESPACHADO/ENTREGADO' || pedidoActual.status === 'CANCELADO';
        despachadoEntregadoBtn.style.opacity = despachadoEntregadoBtn.disabled ? '0.5' : '1';
      }
      actualizarBotonDespachado();
      // Asignar SOLO este onclick, sin sobrescribirlo despu√©s
      despachadoEntregadoBtn.onclick = async () => {
        if (pedidoActual.status === 'CANCELADO') return;
        if (despachadoEntregadoBtn.disabled) return;

        // Guardar cambios autom√°ticamente antes de despachar
        try {
          // Ejecutar la misma l√≥gica que el bot√≥n guardar
          const tipoPago = document.querySelector('input[name="tipoPago"]:checked')?.value || 'Efectivo';
          const tipoEntrega = document.querySelector('input[name="tipoEntrega"]:checked')?.value || 'Retiro en local';

          // Validaci√≥n ALIAS para Transferencia (solo si es admin)
          let alias = '';
          if (tipoPago === 'Transferencia' && admin) {
            const aliasInput = document.getElementById('alias');
            if (aliasInput && aliasInput.value.trim()) {
              alias = aliasInput.value.trim().toUpperCase();
            }
          }

          // Calcular campo entrega
          let entrega = '';
          if (tipoEntrega && tipoEntrega !== 'Retiro en local') {
            entrega = 'Envios';
          }

          // Determinar qui√©n modifica
          let lastModifiedBy = 'usuario';
          let lastModifiedEmail = '';
          let adminViewedValue = false;
          const user = firebase.auth().currentUser;
          if (admin && user) {
            lastModifiedBy = 'admin';
            lastModifiedEmail = user.email || '';
            adminViewedValue = true;
          }

          // Actualizar valorC y valorU antes de guardar
          if (pedidoActual.items) {
            pedidoActual.items.forEach(item => {
              if (item.codigo && sheetValorMap[item.codigo]) {
                const valoresSheet = sheetValorMap[item.codigo];
                // Solo actualizar valorU desde Sheets si NO existe (undefined, null o vac√≠o)
                // Permitir que 0 sea un valor v√°lido (art√≠culos gratuitos)
                if (item.valorU === undefined || item.valorU === null || item.valorU === '') {
                  item.valorU = valoresSheet.valorU;
                }
              }
            });
          }

          // Capturar valores de porcentaje, descuento y env√≠o desde los inputs
          const descuentoInput = document.getElementById('descuentoInput');
          const porcentajeInput = document.getElementById('porcentajeInput');
          const envioInput = document.getElementById('envioInput');
          
          let descuento = 0;
          let porcentaje = 0;
          let envio = 0;
          
          if (descuentoInput) {
            descuento = parseFloat(descuentoInput.value) || 0;
          }
          if (porcentajeInput) {
            porcentaje = parseFloat(porcentajeInput.value) || 0;
          }
          if (envioInput) {
            envio = parseFloat(envioInput.value) || 0;
          }

          // Preparar datos para actualizar
          const updateData = {
            items: pedidoActual.items,
            adminViewed: adminViewedValue,
            lastUpdated: Date.now(),
            tipoPago: tipoPago,
            tipoEntrega: tipoEntrega,
            entrega: entrega,
            lastModifiedBy: lastModifiedBy,
            lastModifiedEmail: lastModifiedEmail
          };

          // Preparar datos de pagos con porcentaje, descuento y env√≠o
          const pagosUpdate = {};
          if (tipoPago === 'Transferencia' && alias && admin) {
            pagosUpdate.alias = alias;
          }
          pagosUpdate.descuento = descuento;
          pagosUpdate.porcentajeDescuento = porcentaje;
          pagosUpdate.envio = envio;

          // Guardar cambios y datos de pagos
          const promises = [
            firebase.database().ref('pedidos/' + pedidoActual.id).update(updateData),
            firebase.database().ref('pedidos/' + pedidoActual.id + '/pagos').update(pagosUpdate)
          ];
          
          await Promise.all(promises);

        } catch (error) {
          alert('Error al guardar cambios antes del despacho: ' + error.message);
          return;
        }

        // Validar ALIAS obligatorio si el tipo de pago es Transferencia
        const tipoPagoRadio = document.querySelector('input[name="tipoPago"]:checked');
        if (tipoPagoRadio && tipoPagoRadio.value === 'Transferencia') {
          const aliasInput = document.getElementById('alias');
          if (!aliasInput || !aliasInput.value.trim()) {
            alert('El campo ALIAS es obligatorio para transferencias antes de despachar el pedido.');
            if (aliasInput) aliasInput.focus();
            return;
          }
        }

        despachadoEntregadoBtn.disabled = true;
        // Funci√≥n para obtener la fecha en el formato de ingresoPedido.js
        function getFechaActual() {
          const now = new Date();
          const pad = n => n.toString().padStart(2, '0');
          return `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        }
        try {
          if (pedidoActual.movimientosRegistrados) {
            await pedidoRef.update({ status: 'DESPACHADO/ENTREGADO', locked: true, fecha: getFechaActual() });
            alert('Pedido marcado como DESPACHADO/ENTREGADO. (Movimientos ya registrados)');
            return;
          }
          // === NUEVO: Actualizar valorC de cada art√≠culo usando el c√≥digo ===
          // Actualizar valores desde Google Sheets para el c√°lculo final
          if (pedidoActual.items) {
            pedidoActual.items.forEach(item => {
              if (item.codigo && sheetValorMap[item.codigo]) {
                const valoresSheet = sheetValorMap[item.codigo];
                // Guardar valorC desde Sheets
                item.valorC = valoresSheet.valorC;
                // Solo actualizar valorU desde Sheets si NO existe (undefined, null o vac√≠o)
                // Permitir que 0 sea un valor v√°lido (art√≠culos gratuitos)
                if (item.valorU === undefined || item.valorU === null || item.valorU === '') {
                  item.valorU = valoresSheet.valorU;
                }
              }
            });
          }
          
          // Actualizar el pedido en Firebase con los nuevos items y status
          await pedidoRef.update({
            items: pedidoActual.items,
            status: 'DESPACHADO/ENTREGADO',
            locked: true,
            fecha: getFechaActual()
          });
          
          // === REGISTRO DE PAGOS ===
          let subtotal = 0;
          let costos = 0;
          if (Array.isArray(pedidoActual.items)) {
            pedidoActual.items.forEach(it => {
              const unitPesos = Math.round(it.valorU || 0);
              subtotal += Math.round(it.cantidad * unitPesos);
              costos += (parseFloat(it.valorC) || 0) * (parseInt(it.cantidad) || 0);
            });
          }
          
          // Obtener valores actuales de descuento y env√≠o
          const descuentoInputPago = document.getElementById('descuentoInput');
          const envioInputPago = document.getElementById('envioInput');
          const porcentajeInputPago = document.getElementById('porcentajeInput');
          
          let descuentoPago = 0;
          let envioPago = 0;
          let porcentajePago = 0;
          
          if (descuentoInputPago) {
            descuentoPago = parseFloat(descuentoInputPago.value) || 0;
          }
          if (envioInputPago) {
            envioPago = parseFloat(envioInputPago.value) || 0;
          }
          if (porcentajeInputPago) {
            porcentajePago = parseFloat(porcentajeInputPago.value) || 0;
          }
          
          // Calcular total final correctamente
          let totalFinal = subtotal - descuentoPago + envioPago;
          if (totalFinal < 0) totalFinal = 0;
          
          const ganancia = subtotal - costos;
          let medioPago = 'efectivo';
          let alias = '';
          const pagoRadio = document.querySelector('input[name="tipoPago"]:checked');
          if (pagoRadio) {
            medioPago = pagoRadio.value.toLowerCase();
            if (pagoRadio.value === 'Transferencia') {
              const aliasInput = document.getElementById('alias');
              if (aliasInput && aliasInput.value.trim()) {
                alias = aliasInput.value.trim().toUpperCase();
              }
            }
          }
          const pagoData = {
            medioPago,
            subtotal,
            costos,
            ganancia,
            totalFinal: totalFinal,
            descuento: descuentoPago,
            porcentajeDescuento: porcentajePago,
            envio: envioPago
          };
          if (alias) {
            pagoData.alias = alias;
          }
          await pedidoRef.child('pagos').set(pagoData);
          // Registrar movimientos de salida leyendo el pedido actualizado
          await registrarMovimientoSalidaDesdePedido(pedidoActual.id);
          // Marcar que ya se registraron movimientos
          await pedidoRef.update({ movimientosRegistrados: true });
          alert('Pedido despachado y movimientos registrados correctamente.');
        } catch (err) {
          await pedidoRef.update({ status: 'ABIERTO', locked: false });
          alert('Error al registrar movimientos de salida: ' + (err.message || err));
          console.error('Error al registrar movimientos:', err);
        } finally {
          despachadoEntregadoBtn.disabled = false;
        }
      };
      // --- FIN bot√≥n despachado ---
      // --- STOCK: El stock se consulta desde Google Sheets columna K ---
    }
    // Mostrar estado
    if (pedidoActual.status === 'DESPACHADO/ENTREGADO') {
      document.getElementById('estado').innerText = 'üì¶ PEDIDO DESPACHADO/ENTREGADO';
    } else if (pedidoActual.status === 'CANCELADO') {
      document.getElementById('estado').innerText = '‚ùå PEDIDO CANCELADO';
    } else if (pedidoActual.locked) {
      document.getElementById('estado').innerText = 'üîí PEDIDO CERRADO';
    } else {
      document.getElementById('estado').innerText = 'üìù PEDIDO ABIERTO';
    }

    // solo pinto si ya tengo los datos de Sheets cargados
    if (Object.keys(sheetValorMap).length > 0) renderItems();

    // Bloqueo por status - permitir modificaciones de tabla para admin autenticado cuando est√° cerrado
    const user = firebase.auth().currentUser;
    const bloqueado = pedidoActual.status === 'CANCELADO' || pedidoActual.status === 'DESPACHADO/ENTREGADO';
    const bloqueadoCompleto = bloqueado || (pedidoActual.locked && !(admin && user));
    
    document.getElementById('agregarItemBtn').disabled = bloqueadoCompleto;
    // Permitir guardar para admin autenticado aunque est√© bloqueado
    document.getElementById('guardarBtn').disabled = bloqueadoCompleto;
    document.getElementById('cancelarBtn').disabled = bloqueadoCompleto;

    // Bloquear radios de pago e entrega si bloqueado
    const pagoRadios = document.getElementsByName('tipoPago');
    for (let r of pagoRadios) r.disabled = bloqueadoCompleto;
    const entregaRadios = document.getElementsByName('tipoEntrega');
    for (let r of entregaRadios) r.disabled = bloqueadoCompleto;

    // visibilidad y texto del bot√≥n toggle seg√∫n rol/estado
    const toggleBtn = document.getElementById('toggleEstadoBtn');
    if (admin) {
      toggleBtn.style.display = 'inline-block';
      if (pedidoActual.locked || pedidoActual.status === 'DESPACHADO/ENTREGADO' || pedidoActual.status === 'CANCELADO') {
        toggleBtn.textContent = 'Reabrir Pedido';
        toggleBtn.onclick = reabrirPedido;
      } else {
        toggleBtn.textContent = 'Cerrar Pedido';
        toggleBtn.onclick = cerrarPedido;
      }
    } else {
      toggleBtn.style.display = 'none';
    }

    // Mostrar bot√≥n Imprimir R√≥tulo solo para admin
    // (eliminado)
    // Mostrar estado
    if (pedidoActual.status === 'DESPACHADO/ENTREGADO') {
      document.getElementById('estado').innerText = 'üì¶ PEDIDO DESPACHADO/ENTREGADO';
    } else if (pedidoActual.status === 'CANCELADO') {
      document.getElementById('estado').innerText = '‚ùå PEDIDO CANCELADO';
    } else if (pedidoActual.locked) {
      document.getElementById('estado').innerText = 'üîí PEDIDO CERRADO';
    } else {
      document.getElementById('estado').innerText = 'üìù PEDIDO ABIERTO';
    }
  }

  // Iniciar carga del pedido
  cargarPedidoInicial();

  // Cleanup: Desactivar listener al cerrar la p√°gina
  window.addEventListener('beforeunload', () => {
    desactivarListenerTiempoReal();
  });

  // Funci√≥n para cargar datos desde Google Sheets (optimizada)
  function cargarDatosSheets() {
    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.RANGO}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`)
      .then(r => r.json())
      .then(data => {
        const values = data.values || [];
        sheetValorMap = {};
        sheetCategoryMap = {};
        
        // Obtener c√≥digos necesarios del pedido actual
        const codigosNecesarios = new Set(
          pedidoActual?.items?.map(item => item.codigo).filter(Boolean) || []
        );
        
        // Si no hay pedido cargado a√∫n, procesar todo (primera carga)
        const procesarTodo = !pedidoActual || codigosNecesarios.size === 0;
        
        values.forEach(row => {
          const categoria = row[0]; // Columna A (categor√≠a)
          const codigo = row[2]; // Columna C (c√≥digo)
          
          // Optimizaci√≥n: solo procesar c√≥digos relevantes si el pedido ya est√° cargado
          if (!procesarTodo && codigo && !codigosNecesarios.has(codigo)) {
            return; // Saltar este registro
          }
          
          const valorU = row[6]; // Columna G (valorU)
          const valorC = row[7]; // Columna H (valorC)
          
          if (codigo) {
            // Limpiar y convertir valorU (eliminar $ y comas)
            let valorULimpio = 0;
            if (valorU) {
              valorULimpio = parseFloat(valorU.toString().replace(/\$/g, '').replace(/,/g, '')) || 0;
            }
            
            // Limpiar y convertir valorC (eliminar $ y comas)
            let valorCLimpio = 0;
            if (valorC) {
              valorCLimpio = parseFloat(valorC.toString().replace(/\$/g, '').replace(/,/g, '')) || 0;
            }
            
            sheetValorMap[codigo] = {
              valorU: valorULimpio,
              valorC: valorCLimpio
            };
            
            // Guardar categor√≠a
            if (categoria) {
              sheetCategoryMap[codigo] = categoria;
            }
          }
        });
        
        // Si ya tengo el pedido cargado, actualizar valores y renderizar
        if (pedidoActual) {
          actualizarValoresItems();
          renderItems();
        }
      })
      .catch(err => {
        console.error('Error cargando datos de Google Sheets:', err);
        alert('Error al cargar los precios desde la base de datos');
        // Ocultar mensaje de carga incluso si hay error
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
      });
  }

  // Funci√≥n para actualizar valorC y valorU de los items del pedido
  function actualizarValoresItems() {
    if (!pedidoActual || !pedidoActual.items || Object.keys(sheetValorMap).length === 0) return;
    
    let itemsActualizados = false;
    pedidoActual.items.forEach(item => {
      if (item.codigo && sheetValorMap[item.codigo]) {
        const valoresSheet = sheetValorMap[item.codigo];
        
        // Solo actualizar valorU desde Sheets si NO existe en Firebase (undefined o null)
        // Permitir que 0 sea un valor v√°lido (art√≠culos gratuitos)
        if (item.valorU === undefined || item.valorU === null || item.valorU === '') {
          if (item.valorU !== valoresSheet.valorU) {
            item.valorU = valoresSheet.valorU;
            itemsActualizados = true;
          }
        }
        
        // Para valorC, solo actualizar si no existe (no se guarda hasta cerrar)
        if (item.valorC === undefined || item.valorC === null || item.valorC === '') {
          if (item.valorC !== valoresSheet.valorC) {
            item.valorC = valoresSheet.valorC;
            itemsActualizados = true;
          }
        }
      }
    });
    
    // No guardar autom√°ticamente en Firebase - solo actualizar el objeto local
    // Los valores se guardar√°n solo al cerrar el pedido
  }

  function getCotizacionActual() {
    // Las cotizaciones ya no son necesarias, devolvemos 1
    return 1;
  }

  // Variable global para cachear los valores
  window.cachedValues = window.cachedValues || {};

  // Funci√≥n global para actualizar todos los c√°lculos
  function actualizarCalculosGlobales() {
    // Calcular subtotal actual
    let subtotal = 0;
    if (pedidoActual && pedidoActual.items) {
      pedidoActual.items.forEach(it => {
        const unitPesos = Math.round(it.valorU || 0);
        subtotal += Math.round(it.cantidad * unitPesos);
      });
    }

    // Actualizar el total en pantalla
    const totalDiv = document.getElementById('total');
    if (totalDiv) {
      totalDiv.textContent = `Subtotal $ ${subtotal.toLocaleString('es-AR')}`;
    }

    // Obtener valores actuales de los inputs
    const porcentajeInput = document.getElementById('porcentajeInput');
    const descuentoInput = document.getElementById('descuentoInput');
    const envioInput = document.getElementById('envioInput');
    const totalFinalDiv = document.getElementById('totalFinalDiv');

    if (porcentajeInput && descuentoInput && envioInput && totalFinalDiv) {
      const porcentaje = parseFloat(porcentajeInput.value) || 0;
      const descuento = parseFloat(descuentoInput.value) || 0;
      const envio = parseFloat(envioInput.value) || 0;

      // Actualizar descuento basado en el porcentaje (siempre)
      const descuentoCalculado = Math.round(subtotal * porcentaje / 100);
      if (descuentoInput.value != descuentoCalculado) {
        descuentoInput.value = descuentoCalculado;
      }

      // Calcular y mostrar total final
      let totalFinal = subtotal - parseFloat(descuentoInput.value || 0) + envio;
      if (totalFinal < 0) totalFinal = 0;
      totalFinalDiv.textContent = `TOTAL FINAL $ ${totalFinal.toLocaleString('es-AR')}`;

      // Actualizar cach√©
      window.cachedValues = {
        ...window.cachedValues,
        porcentaje: parseFloat(porcentajeInput.value) || 0,
        descuento: parseFloat(descuentoInput.value) || 0,
        envio: envio
      };

      // Actualizar en pedidoActual
      if (!pedidoActual.pagos) pedidoActual.pagos = {};
      pedidoActual.pagos.porcentajeDescuento = parseFloat(porcentajeInput.value) || 0;
      pedidoActual.pagos.descuento = parseFloat(descuentoInput.value) || 0;
      pedidoActual.pagos.envio = envio;
    }
  }

  // Variable para memoizaci√≥n de renderItems
  let lastRenderHash = '';

  function renderItems() {
    // Crear hash del estado actual para memoizaci√≥n
    const currentHash = JSON.stringify({
      items: pedidoActual?.items?.map(i => ({ 
        codigo: i.codigo, 
        cantidad: i.cantidad,
        valorU: i.valorU,
        nombre: i.nombre
      })),
      locked: pedidoActual?.locked,
      status: pedidoActual?.status,
      tipoPago: pedidoActual?.tipoPago,
      tipoEntrega: pedidoActual?.tipoEntrega
    });
    
    // Solo re-renderizar si cambi√≥ algo relevante
    if (currentHash === lastRenderHash) {
      console.log('Render omitido - sin cambios relevantes');
      return;
    }
    
    lastRenderHash = currentHash;
    
    const cont = document.getElementById('items');
    cont.innerHTML = '';

    /* ===== tabla base ===== */
    const tbl = document.createElement('table');
    
    // Crear header con columna de stock condicional para admin
    let headerHTML = `
      <tr>
        <th>C√≥digo</th>
        <th>Art√≠culo</th>
        <th class="cant">Cant</th>`;
    
    // Solo mostrar columna de stock para administradores
    if (admin) {
      headerHTML += `<th class="cant">Stock</th>`;
    }
    
    headerHTML += `
        <th>Valor</th>
        <th>Total</th>
        <th class="elim"></th>
      </tr>`;
    
    tbl.innerHTML = headerHTML;
    
    let total = 0;
    // Bloquea si est√° despachado o cancelado, o si est√° cerrado y no es admin autenticado
    const user = firebase.auth().currentUser;
    const bloqueado = pedidoActual.status === 'CANCELADO' || pedidoActual.status === 'DESPACHADO/ENTREGADO' || 
                      (pedidoActual.locked && !(admin && user));
    
    pedidoActual.items.forEach((it, idx) => {
      // Usar directamente valorU desde el item (ya viene en pesos)
      const unitPesos = Math.round(it.valorU || 0);
      const subtotal = Math.round(it.cantidad * unitPesos);
      total += subtotal;

      const row = tbl.insertRow(-1);

      /* 0) C√ìDIGO */
      const codigoCell = row.insertCell(0);
      codigoCell.textContent = it.codigo || '';

      /* 1) NOMBRE clickeable ‚Üí abre lightbox */
      const nameCell = row.insertCell(1);
      const nameSpan = document.createElement('span');
      nameSpan.textContent  = it.nombre;
      nameSpan.style.cursor = 'pointer';
      nameSpan.onclick      = () => abrirLB(it.nombre);
      nameCell.appendChild(nameSpan);

      /* 2) INPUT cantidad */
      const qtyCell = row.insertCell(2);
      qtyCell.className = 'cant';
      const qty = document.createElement('input');
      qty.type  = 'number';
      qty.min   = 1;
      qty.value = it.cantidad;
      qty.style = 'width:40px;text-align:right;font-size:1em;padding:2px 2px;';
      qty.disabled = bloqueado; // Deshabilitar si cerrado o despachado
      qty.onchange = e => {
        if (bloqueado) return;
        pedidoActual.items[idx].cantidad = parseInt(e.target.value, 10) || 1;
        renderItems();
        // Actualizar c√°lculos inmediatamente
        setTimeout(() => actualizarCalculosGlobales(), 100);
      };
      qtyCell.appendChild(qty);

      /* 3) STOCK DISPONIBLE (solo para admin, consultado desde Google Sheets columna K) */
      if (admin) {
        const stockCell = row.insertCell(3);
        stockCell.className = 'cant';
        // Consultar stock desde Google Sheets
        if (window.sheetStockMap && it.codigo) {
          const stockActual = window.sheetStockMap[it.codigo];
          if (typeof stockActual !== 'undefined') {
            stockCell.textContent = stockActual;
            // Aplicar colores seg√∫n disponibilidad
            if (stockActual <= 0) {
              stockCell.style.color = '#e53935';
              stockCell.style.fontWeight = 'bold';
              stockCell.title = 'Sin stock disponible';
            } else if (stockActual < it.cantidad) {
              stockCell.style.color = '#ff9800';
              stockCell.style.fontWeight = 'bold';
              stockCell.title = `Stock insuficiente. Disponible: ${stockActual}, Pedido: ${it.cantidad}`;
            } else if (stockActual <= 5) {
              stockCell.style.color = '#ff9800';
              stockCell.title = 'Stock bajo';
            } else {
              stockCell.style.color = '#4CAF50';
              stockCell.title = 'Stock disponible';
            }
          } else {
            stockCell.textContent = '...';
            stockCell.style.color = '#666';
            stockCell.title = 'Cargando stock...';
          }
        } else {
          stockCell.textContent = '...';
          stockCell.style.color = '#666';
          stockCell.title = 'Cargando stock...';
        }
      }

      /* 4) valor unitario $ - EDITABLE SOLO PARA ADMIN */
      const valorCell = row.insertCell(admin ? 4 : 3);
      
      if (admin && (pedidoActual.status !== 'CANCELADO' && pedidoActual.status !== 'DESPACHADO/ENTREGADO')) {
        // Para administradores: campo editable (excepto cuando est√° cancelado o despachado)
        const valorInput = document.createElement('input');
        valorInput.type = 'number';
        valorInput.min = 0;
        valorInput.value = unitPesos;
        valorInput.style = 'width:80px;text-align:right;font-size:1em;padding:2px 2px;border:1px solid #ddd;';
        valorInput.onchange = e => {
          const nuevoValor = parseFloat(e.target.value) || 0;
          pedidoActual.items[idx].valorU = nuevoValor;
          renderItems(); // Re-renderizar para actualizar subtotal
          // Actualizar c√°lculos inmediatamente
          setTimeout(() => actualizarCalculosGlobales(), 100);
        };
        valorCell.appendChild(valorInput);
      } else {
        // Para clientes o cuando est√° bloqueado: solo mostrar el valor
        valorCell.textContent = unitPesos.toLocaleString('es-AR');
        valorCell.style.textAlign = 'right';
        valorCell.style.padding = '4px 6px';
        valorCell.style.fontWeight = 'bold';
      }

      /* 5) subtotal $ */
      const subtotalCell = row.insertCell(admin ? 5 : 4);
      subtotalCell.textContent = subtotal.toLocaleString('es-AR');

      /* 6) bot√≥n eliminar */
      const delCell = row.insertCell(admin ? 6 : 5);
      delCell.className = 'elim';
      const del = document.createElement('button');
      del.textContent = 'X';
      del.className = 'eliminar-articulo';
      del.disabled = bloqueado; // Deshabilitar si cerrado o despachado
      del.onclick = () => {
        if (bloqueado) return;
        pedidoActual.items.splice(idx, 1); 
        renderItems();
        // Actualizar c√°lculos inmediatamente
        setTimeout(() => actualizarCalculosGlobales(), 100);
      };
      delCell.appendChild(del);
    });

    cont.appendChild(tbl);

    /* ===== total y selector de pago (alineados a la derecha, uno debajo del otro) ===== */
    let totalPagoWrap = document.getElementById('totalPagoWrap');
    if (!totalPagoWrap) {
      totalPagoWrap = document.createElement('div');
      totalPagoWrap.id = 'totalPagoWrap';
      totalPagoWrap.style = 'display:flex;flex-direction:column;align-items:flex-end;margin-top:15px;margin-bottom:10px;width:100%';
      cont.appendChild(totalPagoWrap);
    } else {
      totalPagoWrap.style = 'display:flex;flex-direction:column;align-items:flex-end;margin-top:15px;margin-bottom:10px;width:100%';
    }
    // Total
    let totalDiv = document.getElementById('total');
    if (!totalDiv) {
      totalDiv = document.createElement('div');
      totalDiv.id = 'total';
      totalDiv.style = 'font-weight:bold;font-size:1.2em;text-align:right;';
      totalPagoWrap.appendChild(totalDiv);
    } else if (!totalPagoWrap.contains(totalDiv)) {
      totalPagoWrap.appendChild(totalDiv);
    }
    totalDiv.style = 'font-weight:bold;font-size:1.2em;text-align:right;';

    totalDiv.textContent = `Subtotal $ ${total.toLocaleString('es-AR')}`;

    // Campo Porcentaje y Descuento
    let descuentoDiv = document.getElementById('descuentoDiv');
    if (!descuentoDiv) {
      descuentoDiv = document.createElement('div');
      descuentoDiv.id = 'descuentoDiv';
      descuentoDiv.style = 'font-weight:bold;font-size:1.1em;text-align:right;margin-top:10px;display:flex;align-items:center;justify-content:flex-end;gap:10px;';
      totalPagoWrap.appendChild(descuentoDiv);
    }
    // Obtener valores del cach√© o del pedido
    let descuento = window.cachedValues.descuento;
    let porcentaje = window.cachedValues.porcentaje;
    let envio = window.cachedValues.envio;

    // Si no hay valores en cach√©, obtener de Firebase
    if (descuento === undefined && pedidoActual.pagos && typeof pedidoActual.pagos.descuento === 'number') {
      descuento = pedidoActual.pagos.descuento;
    }
    if (porcentaje === undefined && pedidoActual.pagos && typeof pedidoActual.pagos.porcentajeDescuento === 'number') {
      porcentaje = pedidoActual.pagos.porcentajeDescuento;
    }
    if (envio === undefined && pedidoActual.pagos && typeof pedidoActual.pagos.envio === 'number') {
      envio = pedidoActual.pagos.envio;
    }

    // Valores por defecto si no hay nada
    descuento = descuento || 0;
    porcentaje = porcentaje || 0;
    envio = envio || 0;
    // Input para porcentaje y descuento
    const readonlyStyle = admin ? '' : 'background-color:#f5f5f5;cursor:not-allowed;';
    descuentoDiv.innerHTML = `
      <label for='porcentajeInput' style='font-weight:normal;'>Descuento %</label>
      <input type='number' id='porcentajeInput' min='0' max='100' value='${porcentaje}' style='width:40px;text-align:right;font-size:1em;padding:2px 2px;border:1px solid #ddd;${readonlyStyle}' ${admin ? '' : 'readonly'}>
      <span style='font-weight:normal;'>$</span>
      <input type='number' id='descuentoInput' min='0' value='${descuento}' style='width:80px;text-align:right;font-size:1em;padding:2px 2px;border:1px solid #ddd;${readonlyStyle}' ${admin ? '' : 'readonly'}>
    `;

    // Campo Costo de Envio
    let envioDiv = document.getElementById('envioDiv');
    if (!envioDiv) {
      envioDiv = document.createElement('div');
      envioDiv.id = 'envioDiv';
      envioDiv.style = 'font-weight:normal;font-size:1.1em;text-align:right;margin-top:10px;display:flex;align-items:center;justify-content:flex-end;gap:10px;';
      totalPagoWrap.appendChild(envioDiv);
    }
    envioDiv.innerHTML = `<label for='envioInput' style='font-weight:normal;'>Costo de Envio $</label><input type='number' id='envioInput' min='0' value='${envio}' style='width:80px;text-align:right;font-size:1em;padding:2px 2px;border:1px solid #ddd;font-weight:normal;${readonlyStyle}' ${admin ? '' : 'readonly'}>`;
    // Mostrar/ocultar seg√∫n tipoEntrega
    setTimeout(() => {
      const entregaRadios = document.getElementsByName('tipoEntrega');
      const envioDiv = document.getElementById('envioDiv');
      const envioInput = document.getElementById('envioInput');
      
      // Determinar el tipo de entrega seleccionado inicialmente
      let tipoEntregaSel = '';
      for (let r of entregaRadios) {
        if (r.checked) {
          tipoEntregaSel = r.value;
          break;
        }
      }

      // Mantener el valor original del env√≠o de Firebase
      const envioValorFirebase = (pedidoActual.pagos && typeof pedidoActual.pagos.envio === 'number') ? 
        pedidoActual.pagos.envio : 0;

      // Configurar el evento change para todos los radios
      for (let r of entregaRadios) {
        r.addEventListener('change', () => {
          if (r.value === 'Correo Argentino' && r.checked) {
            envioDiv.style.display = 'flex';
            // Solo restaurar valores si es admin
            if (admin) {
              envioInput.value = envioValorFirebase;
            }
          } else if (r.checked) {
            envioDiv.style.display = 'none';
            // Solo modificar valores si es admin
            if (admin) {
              if (envioInput.value > 0) {
                window.cachedValues.envioTemp = parseFloat(envioInput.value);
              }
              envioInput.value = 0;
            }
          }
          // Actualizar totales solo si es admin
          if (admin) {
            envioInput.dispatchEvent(new Event('input'));
          } else {
            // Para usuarios no admin, actualizar c√°lculos sin modificar valores
            actualizarCalculosGlobales();
          }
        });
      }

      // Configuraci√≥n inicial expl√≠cita basada en el valor actual
      if (tipoEntregaSel === 'Correo Argentino' || pedidoActual.tipoEntrega === 'Correo Argentino') {
        envioDiv.style.display = 'flex';
        if (pedidoActual.pagos && typeof pedidoActual.pagos.envio === 'number') {
          envioInput.value = pedidoActual.pagos.envio;
        }
        // Asegurarse de que el radio correcto est√© seleccionado
        for (let r of entregaRadios) {
          if (r.value === 'Correo Argentino') {
            r.checked = true;
            break;
          }
        }
      } else {
        envioDiv.style.display = 'none';
        envioInput.value = 0;
      }
    }, 0);

    // Campo Total Final
    let totalFinalDiv = document.getElementById('totalFinalDiv');
    if (!totalFinalDiv) {
      totalFinalDiv = document.createElement('div');
      totalFinalDiv.id = 'totalFinalDiv';
      totalFinalDiv.style = 'font-weight:bold;font-size:1.2em;text-align:right;margin-top:10px;color:#222;';
      totalPagoWrap.appendChild(totalFinalDiv);
    }
    // Calcular total final
    let totalFinal = total - descuento + envio;
    if (totalFinal < 0) totalFinal = 0;
    totalFinalDiv.textContent = `TOTAL FINAL $ ${totalFinal.toLocaleString('es-AR')}`;

    // Actualizar descuento, envio y total final al cambiar porcentaje, descuento o envio
    setTimeout(() => {
      const porcentajeInput = document.getElementById('porcentajeInput');
      const descuentoInput = document.getElementById('descuentoInput');
      const envioInput = document.getElementById('envioInput');
      const totalFinalDiv = document.getElementById('totalFinalDiv');

      function actualizarTotalFinal() {
        actualizarCalculosGlobales();
      }
      
      function actualizarPorPorcentaje() {
        let porc = parseFloat(porcentajeInput.value) || 0;
        if (porc < 0) porc = 0;
        if (porc > 100) porc = 100;
        porcentajeInput.value = porc;
        
        actualizarCalculosGlobales();
      }
      
      function actualizarPorDescuento() {
        let desc = parseInt(descuentoInput.value, 10) || 0;
        if (desc < 0) desc = 0;
        descuentoInput.value = desc;
        
        // Actualizar el porcentaje basado en el descuento
        const total = calcularSubtotalActual();
        const porc = total > 0 ? Math.round((desc/total)*100) : 0;
        porcentajeInput.value = porc;
        actualizarCalculosGlobales();
      }

      function calcularSubtotalActual() {
        let subtotal = 0;
        if (pedidoActual && pedidoActual.items) {
          pedidoActual.items.forEach(it => {
            const unitPesos = Math.round(it.valorU || 0);
            subtotal += Math.round(it.cantidad * unitPesos);
          });
        }
        return subtotal;
      }

      // Configurar event listeners solo para administradores
      if (admin) {
        // Remover listeners previos si existen para evitar duplicados
        const newPorcentajeInput = porcentajeInput.cloneNode(true);
        porcentajeInput.parentNode.replaceChild(newPorcentajeInput, porcentajeInput);
        const porcentajeInputFinal = document.getElementById('porcentajeInput');
        
        const newDescuentoInput = descuentoInput.cloneNode(true);
        descuentoInput.parentNode.replaceChild(newDescuentoInput, descuentoInput);
        const descuentoInputFinal = document.getElementById('descuentoInput');
        
        const newEnvioInput = envioInput.cloneNode(true);
        envioInput.parentNode.replaceChild(newEnvioInput, envioInput);
        const envioInputFinal = document.getElementById('envioInput');
        
        // Flag para prevenir ciclos entre porcentaje y descuento
        let actualizandoPorPorcentaje = false;
        
        porcentajeInputFinal.addEventListener('input', function() {
          actualizandoPorPorcentaje = true;
          actualizarPorPorcentaje();
          actualizandoPorPorcentaje = false;
          
          // Auto-guardar usando batch updates (2 segundos de debounce)
          const porc = parseFloat(this.value) || 0;
          const desc = parseFloat(descuentoInputFinal.value) || 0;
          programarActualizacion(
            `pedidos/${pedidoActual.id}/pagos`,
            { porcentajeDescuento: porc, descuento: desc }
          );
        });
        
        descuentoInputFinal.addEventListener('input', function() {
          // Solo actualizar el porcentaje si el usuario edit√≥ manualmente el descuento
          if (!actualizandoPorPorcentaje) {
            actualizarPorDescuento();
          } else {
            actualizarTotalFinal();
          }
          
          // Auto-guardar usando batch updates (2 segundos de debounce)
          const desc = parseFloat(this.value) || 0;
          const porc = parseFloat(porcentajeInputFinal.value) || 0;
          programarActualizacion(
            `pedidos/${pedidoActual.id}/pagos`,
            { descuento: desc, porcentajeDescuento: porc }
          );
        });
        
        envioInputFinal.addEventListener('input', function() {
          actualizarTotalFinal();
          
          // Auto-guardar usando batch updates (2 segundos de debounce)
          const env = parseFloat(this.value) || 0;
          programarActualizacion(
            `pedidos/${pedidoActual.id}/pagos`,
            { envio: env }
          );
        });
      }
    }, 0);

    // Selector de pago
    let pagoDiv = document.getElementById('pagoSelector');
    if (!pagoDiv) {
      pagoDiv = document.createElement('div');
      pagoDiv.id = 'pagoSelector';
      pagoDiv.style = 'margin-top:18px;text-align:left;width:100%';

    // L√≠nea gris sutil
    let lineaDiv1 = document.getElementById('linea1');
    if (!lineaDiv1) {
      lineaDiv1 = document.createElement('div');
      lineaDiv1.id = 'linea1';
      lineaDiv1.style = 'border-top:1px solid #ddd;margin:8px 0 6px 0;width:100%';
      totalPagoWrap.appendChild(lineaDiv1);
    } else if (!totalPagoWrap.contains(lineaDiv1)) {
      totalPagoWrap.appendChild(lineaDiv1);
    }
      pagoDiv.innerHTML = `
        <div style="display:flex;align-items:center;">
          <div style="font-weight:bold;min-width:120px;">Pago</div>
          <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:center;">
            <label style="margin-right:15px;display:inline-flex;align-items:center;">
              <input type="radio" name="tipoPago" value="Efectivo"> Efectivo
            </label>
            <label style="display:inline-flex;align-items:center;">
              <input type="radio" name="tipoPago" value="Transferencia"> Transferencia
            </label>
          </div>
        </div>
        <div id="aliasRow" style="display:none;margin-top:10px;">
          <div style="display:flex;align-items:center;">
            <div style="font-weight:bold;min-width:75px;">ALIAS</div>
            <input type="text" id="alias" name="alias" maxlength="50" style="text-transform:uppercase;padding:5px;border:1px solid #ddd;border-radius:4px;width:200px;" list="aliasDatalist">
          </div>
        </div>
      `;
      totalPagoWrap.appendChild(pagoDiv);
    } else if (!totalPagoWrap.contains(pagoDiv)) {
      totalPagoWrap.appendChild(pagoDiv);
    }
    pagoDiv.style = 'margin-top:18px;text-align:left;width:100%';

    // L√≠nea gris sutil
    let lineaDiv2 = document.getElementById('linea2');
    if (!lineaDiv2) {
      lineaDiv2 = document.createElement('div');
      lineaDiv2.id = 'linea2';
      lineaDiv2.style = 'border-top:1px solid #ddd;margin:8px 0 6px 0;width:100%';
      totalPagoWrap.appendChild(lineaDiv2);
    } else if (!totalPagoWrap.contains(lineaDiv2)) {
      totalPagoWrap.appendChild(lineaDiv);
    }
    
    // Selector de entrega
    let entregaDiv = document.getElementById('entregaSelector');
    if (!entregaDiv) {
      entregaDiv = document.createElement('div');
      entregaDiv.id = 'entregaSelector';
      entregaDiv.style = 'margin-top:18px;text-align:left;width:100%';
      entregaDiv.innerHTML = `
      <div style="max-width:600px;margin:30px auto 0 auto;font-size:0.90em;color:#444;text-align:left;opacity:0.85;"></div>
        <div style="display:flex;align-items:center;">
          <div style="font-weight:bold;min-width:120px;">Entrega</div>
          <div style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;">
            <label style="display:inline-flex;align-items:center;">
              <input type="radio" name="tipoEntrega" value="Retiro en local">
              <img src="logo.png" alt="Retiro en local" style="width:80px;vertical-align:middle;">
            </label>
            <label style="display:inline-flex;align-items:center;">
              <input type="radio" name="tipoEntrega" value="Motomensajeria">
              <img src="logo-moto.png" alt="Motomensajeria" style="width:35px;vertical-align:middle;">
            </label>
            <label style="display:inline-flex;align-items:center;">
              <input type="radio" name="tipoEntrega" value="Correo Argentino">
              <img src="logo-correo.png" alt="Correo Argentino" style="width:80px;vertical-align:middle;">
            </label>
            <label style="display:inline-flex;align-items:center;">
              <input type="radio" name="tipoEntrega" value="Via Cargo">
              <img src="logo-viacargo.png" alt="Via Cargo" style="width:80px;vertical-align:middle;">
            </label>
          </div>
        </div>
      `;
      totalPagoWrap.appendChild(entregaDiv);
    } else if (!totalPagoWrap.contains(entregaDiv)) {
      totalPagoWrap.appendChild(entregaDiv);
    }
    entregaDiv.style = 'margin-top:18px;text-align:left;width:100%';

    // L√≠nea gris sutil
    let lineaDiv3 = document.getElementById('linea3');
    if (!lineaDiv3) {
      lineaDiv3 = document.createElement('div');
      lineaDiv3.id = 'linea3';
      lineaDiv3.style = 'border-top:1px solid #ddd;margin:8px 0 6px 0;width:100%';
      totalPagoWrap.appendChild(lineaDiv3);
    } else if (!totalPagoWrap.contains(lineaDiv2)) {
      totalPagoWrap.appendChild(lineaDiv);
    }

    // === Campo Nota (solo visible para admin) ===
    let notaDiv = document.getElementById('notaDiv');
    if (admin && !notaDiv) {
      notaDiv = document.createElement('div');
      notaDiv.id = 'notaDiv';
      // Campo Nota con select y fecha de actualizaci√≥n
      notaDiv.innerHTML = `
        <div style="display:flex;align-items:center;margin-top:15px;width:100%;max-width:none;">
          <div style="font-weight:bold;min-width:120px;">Nota</div>
          <div style="flex:1;max-width:none;display:flex;flex-direction:column;gap:0.25rem;">
            <select id="notaSelect" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;font-family:Arial,sans-serif;font-size:0.95em;box-sizing:border-box;cursor:pointer;">
              <option value="">---</option>
              <option value="esperando respuesta">Esperando respuesta</option>
              <option value="esperando cierre">Esperando cierre</option>
              <option value="espera cotizaci√≥n">Espera cotizaci√≥n</option>
              <option value="esperando pago">Esperando pago</option>
              <option value="pago">Pago</option>
              <option value="retira">Retira</option>
              <option value="respuesta pendiente">Respuesta Pendiente</option>
              <option value="no responde">No responde</option>
              <option value="no cumple minimo">No cumple minimo</option>
              <option value="???">???</option>
            </select>
            <span id="notaFechaLabel" style="font-size:0.7rem;color:#999;font-style:italic;text-align:left;"></span>
          </div>
        </div>
      `;
      totalPagoWrap.appendChild(notaDiv);
      // Cargar valor de Nota y fecha si existe y es admin
      setTimeout(() => {
        const notaSelect = document.getElementById('notaSelect');
        const notaFechaLabel = document.getElementById('notaFechaLabel');
        if (notaSelect && admin) {
          if (pedidoActual.nota) notaSelect.value = pedidoActual.nota;
          if (pedidoActual.notaFecha) {
            const notaFecha = new Date(pedidoActual.notaFecha);
            notaFechaLabel.textContent = `Actualizaci√≥n: ${notaFecha.toLocaleDateString('es-AR')} ${notaFecha.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`;
          } else {
            notaFechaLabel.textContent = '';
          }
          notaSelect.addEventListener('change', function() {
            const nuevaNota = this.value;
            const ahora = Date.now();
            
            // Guardar inmediatamente (sin batch) para que se vea el cambio
            firebase.database().ref('pedidos/' + pedidoActual.id).update({ nota: nuevaNota, notaFecha: ahora })
              .then(() => {
                const fechaHora = new Date(ahora);
                notaFechaLabel.textContent = (nuevaNota && nuevaNota.trim() !== '')
                  ? `Actualizaci√≥n: ${fechaHora.toLocaleDateString('es-AR')} ${fechaHora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`
                  : '';
              })
              .catch(() => console.error('Error al guardar la nota'));
          });
        }
      }, 0);
    } else if (admin && !totalPagoWrap.contains(notaDiv)) {
      totalPagoWrap.appendChild(notaDiv);
    }

    // === Seleccionar radio buttons seg√∫n lo guardado ===
    setTimeout(() => {
      // Tipo de Pago
      const pagoRadios = document.getElementsByName('tipoPago');
      const pagoValue = pedidoActual.tipoPago || null;
      for (let r of pagoRadios) {
        r.checked = (pagoValue !== null && r.value === pagoValue);
      }
      // Tipo de Entrega
      const entregaRadios = document.getElementsByName('tipoEntrega');
      const entregaValue = pedidoActual.tipoEntrega || null;
      for (let r of entregaRadios) {
        r.checked = (entregaValue !== null && r.value === entregaValue);
      }
      
      // Cargar valor de Nota si existe y es admin
      const notaTextarea = document.getElementById('notaTextarea');
      if (notaTextarea && admin && pedidoActual.nota) {
        notaTextarea.value = pedidoActual.nota;
      }
      
      // Cargar valor del ALIAS si existe y es admin
      const aliasInput = document.getElementById('alias');
      if (aliasInput && admin) {
        if (pedidoActual.pagos && pedidoActual.pagos.alias) {
          aliasInput.value = pedidoActual.pagos.alias;
        } else {
          aliasInput.value = ''; // Limpiar si no hay alias guardado
        }
      }
      
      // Actualizar visibilidad del ALIAS y configurar eventos (solo para admin)
      if (admin) {
        actualizarVisibilidadAlias();
        configurarCampoAlias();
        
        // Asignar listeners de tipo de pago inmediatamente
        const pagoRadiosInline = document.getElementsByName('tipoPago');
        for (let r of pagoRadiosInline) {
          r.removeEventListener('change', actualizarVisibilidadAlias);
          r.addEventListener('change', actualizarVisibilidadAlias);
          // Auto-guardar tipo de pago
          r.removeEventListener('change', guardarTipoPago);
          r.addEventListener('change', guardarTipoPago);
        }
      }
      
      // Asignar listeners de entrega inmediatamente
      const entregaRadiosInline = document.getElementsByName('tipoEntrega');
      for (let r of entregaRadiosInline) {
        r.removeEventListener('change', actualizarEstadoBotonesPorEntrega);
        r.addEventListener('change', actualizarEstadoBotonesPorEntrega);
        // Auto-guardar tipo de entrega (solo admin)
        if (admin) {
          r.removeEventListener('change', guardarTipoEntrega);
          r.addEventListener('change', guardarTipoEntrega);
        }
      }
      
      // Llamar para actualizar el estado de los botones despu√©s de renderizar
      actualizarEstadoBotonesPorEntrega();
      
      // Actualizar todos los c√°lculos despu√©s de renderizar
      setTimeout(() => actualizarCalculosGlobales(), 200);
    }, 0);
    
    // Ocultar mensaje de carga cuando todo est√© listo
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'none';
    }
  }


  /* -------- BOT√ìN PARA IR AL CAT√ÅLOGO EN MODO EDICI√ìN -------- */
  document.getElementById('agregarItemBtn').onclick = () => {
    if (pedidoActual.locked) return;
    window.location.href = `mayorista.html?pedido=${id}`;
  };

  /* === Guardar Cambios === */
document.getElementById('guardarBtn').onclick = async () => {
  /* 1. Validaci√≥n opcional */
  if (!pedidoActual || !pedidoActual.items || !pedidoActual.items.length) {
    alert('El pedido est√° vac√≠o.');
    return;
  }

  try {
    // Primero obtener los items actuales desde Firebase para preservar valorC y valorU
    const pedidoSnapshot = await firebase.database().ref('pedidos/' + pedidoActual.id).once('value');
    const pedidoFirebase = pedidoSnapshot.val();
    const itemsFirebase = pedidoFirebase?.items || [];

    // Crear mapa de items existentes en Firebase por c√≥digo para preservar valores
    const itemsFirebaseMap = {};
    itemsFirebase.forEach((item, index) => {
      if (item && item.codigo) {
        itemsFirebaseMap[item.codigo] = {
          valorC: item.valorC,
          valorU: item.valorU,
          index: index
        };
      }
    });

    // Crear nueva lista de items combinando los cambios locales con valores preservados
    const itemsParaGuardar = pedidoActual.items.map(item => {
      const itemCopia = { ...item };
      
      // Eliminar valorC y valorU de la copia local
      delete itemCopia.valorC;
      delete itemCopia.valorU;
      
      // Si el item ya exist√≠a en Firebase, preservar sus valores
      if (item.codigo && itemsFirebaseMap[item.codigo]) {
        const valoresExistentes = itemsFirebaseMap[item.codigo];
        if (valoresExistentes.valorC !== undefined) {
          itemCopia.valorC = valoresExistentes.valorC;
        }
        if (valoresExistentes.valorU !== undefined) {
          itemCopia.valorU = valoresExistentes.valorU;
        }
      }
      
      return itemCopia;
    });

    // Obtener selecci√≥n de pago y entrega
    const tipoPago = document.querySelector('input[name="tipoPago"]:checked')?.value || 'Efectivo';
    const tipoEntrega = document.querySelector('input[name="tipoEntrega"]:checked')?.value || 'Retiro en local';

    // Validaci√≥n ALIAS para Transferencia (solo si es admin)
    let alias = '';
    if (tipoPago === 'Transferencia' && admin) {
      const aliasInput = document.getElementById('alias');
      if (aliasInput && aliasInput.value.trim()) {
        alias = aliasInput.value.trim().toUpperCase();
      }
    }

    // Calcular campo entrega
    let entrega = '';
    if (tipoEntrega && tipoEntrega !== 'Retiro en local') {
      entrega = 'Envios';
    }

    // Determinar qui√©n modifica
    let lastModifiedBy = 'usuario';
    let lastModifiedEmail = '';
    let adminViewedValue = false;
    const user = firebase.auth().currentUser;
    if (admin && user) {
      lastModifiedBy = 'admin';
      lastModifiedEmail = user.email || '';
      adminViewedValue = true;
    }


    // Obtener nota y fecha (solo si es admin)
    let nota = '';
    let notaFecha = null;
    if (admin) {
      const notaSelect = document.getElementById('notaSelect');
      if (notaSelect) {
        nota = notaSelect.value.trim();
        if (nota) notaFecha = Date.now();
      }
    }

    // Preparar datos para actualizar (incluye items completos con valores preservados)
    const updateData = {
      items: itemsParaGuardar, // Array completo con cambios pero valores preservados
      adminViewed: adminViewedValue,
      lastUpdated: Date.now(),
      tipoPago: tipoPago,
      tipoEntrega: tipoEntrega,
      entrega: entrega,
      lastModifiedBy: lastModifiedBy,
      lastModifiedEmail: lastModifiedEmail
    };

    // Agregar nota y fecha solo si es admin y tiene contenido
    if (admin && nota) {
      updateData.nota = nota;
      updateData.notaFecha = notaFecha;
    }

    // Preparar promesas para actualizaci√≥n
    const promises = [
      firebase.database().ref('pedidos/' + pedidoActual.id).update(updateData)
    ];




    // Guardar descuento, porcentaje, envio y totalFinal en pedidos.pagos
    const descuentoInput = document.getElementById('descuentoInput');
    const porcentajeInput = document.getElementById('porcentajeInput');
    const envioInput = document.getElementById('envioInput');
    let descuento = 0;
    let porcentaje = 0;
    let envio = 0;
    if (descuentoInput) {
      descuento = parseInt(descuentoInput.value, 10);
      if (isNaN(descuento) || descuento < 0) descuento = 0;
    }
    if (porcentajeInput) {
      porcentaje = parseInt(porcentajeInput.value, 10);
      if (isNaN(porcentaje) || porcentaje < 0) porcentaje = 0;
      if (porcentaje > 100) porcentaje = 100;
    }
    if (envioInput) {
      envio = parseInt(envioInput.value, 10);
      if (isNaN(envio) || envio < 0) envio = 0;
    }
    let totalFinal = 0;
    if (pedidoActual.items && pedidoActual.items.length) {
      let totalTmp = 0;
      pedidoActual.items.forEach(it => {
        const unitPesos = Math.round(it.valorU || 0);
        totalTmp += Math.round(it.cantidad * unitPesos);
      });
      totalFinal = totalTmp - descuento + envio;
      if (totalFinal < 0) totalFinal = 0;
    }

    // Guardar ALIAS, descuento, porcentaje y envio en pedidos.pagos
    const pagosUpdate = {};
    if (tipoPago === 'Transferencia' && alias && admin) {
      pagosUpdate.alias = alias;
    }
    pagosUpdate.descuento = descuento;
    pagosUpdate.porcentajeDescuento = porcentaje;
    pagosUpdate.envio = envio;
    pagosUpdate.totalFinal = totalFinal;
    promises.push(
      firebase.database().ref('pedidos/' + pedidoActual.id + '/pagos').update(pagosUpdate)
    );

    await Promise.all(promises);
    alert('Pedido actualizado ‚úîÔ∏è');
    
  } catch (error) {
    console.error('Error al guardar:', error);
    alert('Error al guardar: ' + error.message);
  }
};


const cerrarPedido = () => {
  // Validar que ambos radios est√©n seleccionados
  const tipoPago = document.querySelector('input[name="tipoPago"]:checked');
  const tipoEntrega = document.querySelector('input[name="tipoEntrega"]:checked');
  if (!tipoPago || !tipoEntrega) {
    alert('Debe seleccionar un tipo de pago y un tipo de entrega antes de cerrar el pedido.');
    return;
  }
  
  if (!confirm("¬øCerrar definitivamente el pedido?")) return;
  
  // Actualizar valorC y valorU desde Google Sheets antes de cerrar
  if (pedidoActual.items) {
    pedidoActual.items.forEach(item => {
      if (item.codigo && sheetValorMap[item.codigo]) {
        const valoresSheet = sheetValorMap[item.codigo];
        // Guardar valorC desde Sheets
        item.valorC = valoresSheet.valorC;
        // Solo actualizar valorU desde Sheets si NO existe (undefined, null o vac√≠o)
        // Permitir que 0 sea un valor v√°lido (art√≠culos gratuitos)
        if (item.valorU === undefined || item.valorU === null || item.valorU === '') {
          item.valorU = valoresSheet.valorU;
        }
      }
    });
  }
  
  // Determinar qui√©n modifica
  let lastModifiedBy = 'usuario';
  let lastModifiedEmail = '';
  if (admin && firebase.auth().currentUser) {
    lastModifiedBy = 'admin';
    lastModifiedEmail = firebase.auth().currentUser.email || '';
  }
  
  // Primero guardar los datos b√°sicos del pedido (sin values)
  const tipoPagoFinal = tipoPago.value || 'Efectivo';
  const tipoEntregaFinal = tipoEntrega.value || 'Retiro en local';
  let entrega = '';
  if (tipoEntregaFinal !== 'Retiro en local') {
    entrega = 'Envios';
  }
  
  // Capturar valores de porcentaje, descuento y env√≠o desde los inputs
  const descuentoInput = document.getElementById('descuentoInput');
  const porcentajeInput = document.getElementById('porcentajeInput');
  const envioInput = document.getElementById('envioInput');
  
  let descuento = 0;
  let porcentaje = 0;
  let envio = 0;
  
  if (descuentoInput) {
    descuento = parseFloat(descuentoInput.value) || 0;
  }
  if (porcentajeInput) {
    porcentaje = parseFloat(porcentajeInput.value) || 0;
  }
  if (envioInput) {
    envio = parseFloat(envioInput.value) || 0;
  }

  // Calcular total final
  let totalFinal = 0;
  if (pedidoActual.items && pedidoActual.items.length) {
    let subtotal = 0;
    pedidoActual.items.forEach(it => {
      const unitPesos = Math.round(it.valorU || 0);
      subtotal += Math.round(it.cantidad * unitPesos);
    });
    totalFinal = subtotal - descuento + envio;
    if (totalFinal < 0) totalFinal = 0;
  }
  
  // Preparar datos para cerrar
  const updateData = {
    locked: true, 
    status: 'CERRADO', 
    lastModifiedBy, 
    lastModifiedEmail,
    tipoPago: tipoPagoFinal,
    tipoEntrega: tipoEntregaFinal,
    entrega: entrega,
    items: pedidoActual.items // Guardar items CON valorC y valorU
  };
  
  // Preparar datos de pagos con porcentaje, descuento, env√≠o y total final
  const pagosUpdate = {
    descuento: descuento,
    porcentajeDescuento: porcentaje,
    envio: envio,
    totalFinal: totalFinal
  };
  
  // Guardar ALIAS si es transferencia y hay alias
  const promises = [
    pedidoRef.update(updateData),
    pedidoRef.child('pagos').update(pagosUpdate)
  ];
  
  if (tipoPagoFinal === 'Transferencia' && admin) {
    const aliasInput = document.getElementById('alias');
    if (aliasInput && aliasInput.value.trim()) {
      const alias = aliasInput.value.trim().toUpperCase();
      pagosUpdate.alias = alias;
    }
  }
  
  // Al cerrar, guardo los items actualizados con valorC y valorU
  Promise.all(promises)
    .then(() => alert("Pedido cerrado"))
    .catch(() => alert("Error al cerrar el pedido"));
};

const reabrirPedido = async () => {
  if (!admin) return;            // solo admin puede reabrir
  if (!pedidoActual.locked && pedidoActual.status !== 'CANCELADO' && pedidoActual.status !== 'DESPACHADO/ENTREGADO') return;
  if (!confirm("¬øQuer√©s reabrir este pedido?")) return;
  // Determinar qui√©n modifica
  let lastModifiedBy = 'usuario';
  let lastModifiedEmail = '';
  if (admin && firebase.auth().currentUser) {
    lastModifiedBy = 'admin';
    lastModifiedEmail = firebase.auth().currentUser.email || '';
  }
  
  // Eliminar valorC y valorU de todos los items antes de reabrir
  if (pedidoActual.items) {
    pedidoActual.items.forEach(item => {
      delete item.valorC;
      delete item.valorU;
    });
  }
  
  try {
    await pedidoRef.update({ 
      locked: false, 
      status: 'ABIERTO', 
      lastModifiedBy, 
      lastModifiedEmail, 
      movimientosRegistrados: false,
      items: pedidoActual.items // Guardar items sin valorC y valorU
    });
    // Eliminar movimientos relacionados a este pedido
    const movimientosSnap = await db.ref('movimientos').orderByChild('pedidoId').equalTo(pedidoActual.id).once('value');
    const movimientos = movimientosSnap.val();
    if (movimientos) {
      const updates = {};
      Object.keys(movimientos).forEach(key => {
        updates[key] = null;
      });
      await db.ref('movimientos').update(updates);
    }
    alert("Pedido reabierto y movimientos eliminados.");
  } catch (e) {
    alert("Error al reabrir o eliminar movimientos");
  }
};

  document.getElementById('cancelarBtn').onclick = async () => {
  if (pedidoActual.locked || pedidoActual.status === 'CANCELADO') return; // bloqueado si cerrado o ya cancelado
  if (!confirm("¬øSeguro que desea cancelar el pedido? Esta acci√≥n es IRREVERSIBLE y el pedido no podr√° ser modificado ni reactivado.")) return;
  // Determinar qui√©n modifica
  let lastModifiedBy = 'usuario';
  let lastModifiedEmail = '';
  if (admin && firebase.auth().currentUser) {
    lastModifiedBy = 'admin';
    lastModifiedEmail = firebase.auth().currentUser.email || '';
  }
  try {
    await pedidoRef.update({ status: 'CANCELADO', locked: true, lastModifiedBy, lastModifiedEmail, movimientosRegistrados: false });
    // Eliminar movimientos relacionados a este pedido
    const movimientosSnap = await db.ref('movimientos').orderByChild('pedidoId').equalTo(pedidoActual.id).once('value');
    const movimientos = movimientosSnap.val();
    if (movimientos) {
      const updates = {};
      Object.keys(movimientos).forEach(key => {
        updates[key] = null;
      });
      await db.ref('movimientos').update(updates);
    }
    alert("Pedido cancelado. Ya no podr√° ser modificado. Los movimientos asociados han sido eliminados.");
  } catch (e) {
    alert("Error al cancelar o eliminar movimientos");
  }
};


/* === Mapa de im√°genes por nombre === */
const mapImg = {};

/* Lo llenamos apenas cargamos los datos de Sheets */
// Tambi√©n se crea un mapa para stock por c√≥digo desde columna K
window.sheetStockMap = {};
fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_SHEETS_CONFIG.RANGO}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`)
  .then(r=>r.json())
  .then(({values})=>{
    values.forEach(row=>{
      const nombre = row[3];
      const url    = row[1] || '';
      mapImg[nombre] = url.split(',').map(u=>u.trim()).filter(Boolean);
      // Columna K = √≠ndice 10 (A=0, B=1, ..., K=10)
      const codigo = row[2];
      const stockK = row[10];
      if (codigo && typeof stockK !== 'undefined') {
        // Convierte a n√∫mero si es posible
        window.sheetStockMap[codigo] = parseInt(stockK, 10) || 0;
      }
    });
    // Despu√©s de cargar im√°genes y stock, cargar tambi√©n los valores si a√∫n no est√°n cargados
    if (Object.keys(sheetValorMap).length === 0) {
      cargarDatosSheets();
    }
  });

  function abrirLB(nombre){
  const urls = mapImg[nombre] || [];
  if (!urls.length){ alert("Imagen no disponible"); return; }
  document.getElementById('lbImg').src = urls[0];   // primera imagen
  document.getElementById('imgLightbox').style.display = 'flex';
}

function cerrarLB(e){
  if (e.target === e.currentTarget || e.target.classList.contains('close')){
    document.getElementById('imgLightbox').style.display = 'none';
  }
}

/* Modal para editar datos del cliente */
let modalEditCliente = document.getElementById('modalEditCliente');
// Modal para editar datos del cliente: ancho m√°ximo 500px
if (!modalEditCliente) {
  modalEditCliente = document.createElement('div');
  modalEditCliente.id = 'modalEditCliente';
  modalEditCliente.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:5000;';
  modalEditCliente.innerHTML = `
    <div style="background:#fff;padding:20px 30px;border-radius:8px;min-width:300px;max-width:500px;width:100%;position:relative;">
      <button id="closeEditCliente" style="position:absolute;top:10px;right:15px;font-size:1.5em;background:none;border:none;cursor:pointer;">√ó</button>
      <h3>Editar datos del cliente</h3>
      <input id="editNombre" type="text" placeholder="Nombre y Apellido" style="width:100%;margin-bottom:8px;">
      <input id="editDireccion" type="text" placeholder="Direcci√≥n Completa" style="width:100%;margin-bottom:8px;">
      <input id="editLocalidad" type="text" placeholder="Localidad" style="width:100%;margin-bottom:8px;">
      <select id="editProvincia" style="width:100%;margin-bottom:8px;">
        <option value="">Seleccione Provincia</option>
        <option value="CABA">CABA</option>
        <option value="Gran Buenos Aires">Gran Buenos Aires</option>
        <option value="Buenos Aires">Buenos Aires</option>
        <option value="Catamarca">Catamarca</option>
        <option value="Chaco">Chaco</option>
        <option value="Chubut">Chubut</option>
        <option value="C√≥rdoba">C√≥rdoba</option>
        <option value="Corrientes">Corrientes</option>
        <option value="Entre R√≠os">Entre R√≠os</option>
        <option value="Formosa">Formosa</option>
        <option value="Jujuy">Jujuy</option>
        <option value="La Pampa">La Pampa</option>
        <option value="La Rioja">La Rioja</option>
        <option value="Mendoza">Mendoza</option>
        <option value="Misiones">Misiones</option>
        <option value="Neuqu√©n">Neuqu√©n</option>
        <option value="R√≠o Negro">R√≠o Negro</option>
        <option value="Salta">Salta</option>
        <option value="San Juan">San Juan</option>
        <option value="San Luis">San Luis</option>
        <option value="Santa Cruz">Santa Cruz</option>
        <option value="Santa Fe">Santa Fe</option>
        <option value="Santiago del Estero">Santiago del Estero</option>
        <option value="Tierra del Fuego">Tierra del Fuego</option>
        <option value="Tucum√°n">Tucum√°n</option>
      </select>
      <input id="editDni" type="text" placeholder="DNI" style="width:100%;margin-bottom:8px;">
      <input id="editTelefono" type="text" placeholder="Tel√©fono (opcional)" style="width:100%;margin-bottom:8px;">
      <input id="editEmail" type="email" placeholder="Email" style="width:100%;margin-bottom:8px;" readonly>
      <button id="guardarEditCliente" style="background:#4CAF50;width:100%;margin-top:10px;">Guardar</button>
    </div>
  `;
  document.body.appendChild(modalEditCliente);
}

// Abrir modal con datos actuales
const editarBtn = document.getElementById('editarClienteBtn');
editarBtn.onclick = () => {
  // Permitir editar datos personales si el pedido est√° abierto o si es admin
  if (!admin && pedidoActual.locked) return;
  document.getElementById('editNombre').value = pedidoActual.cliente?.nombre || '';
  document.getElementById('editLocalidad').value = pedidoActual.cliente?.localidad || '';
  document.getElementById('editDireccion').value = pedidoActual.cliente?.direccion || '';
  document.getElementById('editProvincia').value = pedidoActual.cliente?.provincia || '';
  document.getElementById('editDni').value = pedidoActual.cliente?.dni || '';
  document.getElementById('editTelefono').value = pedidoActual.cliente?.telefono || '';
  document.getElementById('editEmail').value = pedidoActual.cliente?.email || '';
  modalEditCliente.style.display = 'flex';
};
document.getElementById('closeEditCliente').onclick = () => {
  modalEditCliente.style.display = 'none';
};

// Guardar cambios en cliente
const guardarEditBtn = document.getElementById('guardarEditCliente');
guardarEditBtn.onclick = () => {
  const nuevoNombre = document.getElementById('editNombre').value.trim();
  const nuevaLocalidad = document.getElementById('editLocalidad').value.trim();
  const nuevaDireccion = document.getElementById('editDireccion').value.trim();
  const nuevaProvincia = document.getElementById('editProvincia').value;
  const nuevoDni = document.getElementById('editDni').value.trim();
  const nuevoTelefono = document.getElementById('editTelefono').value.trim();
  const email = document.getElementById('editEmail').value.trim();
  // Solo Nombre y Email son obligatorios
  if (!nuevoNombre || !email) {
    alert('Los campos Nombre y Email son obligatorios.');
    return;
  }
  pedidoRef.update({
    'cliente/nombre': nuevoNombre,
    'cliente/localidad': nuevaLocalidad,
    'cliente/direccion': nuevaDireccion,
    'cliente/provincia': nuevaProvincia,
    'cliente/dni': nuevoDni,
    'cliente/telefono': nuevoTelefono,
    'cliente/email': email
  }).then(() => {
    if (email) {
      db.ref('clientes').orderByChild('email').equalTo(email).once('value')
        .then(snap => {
          const updates = {};
          if (snap.exists()) {
            Object.keys(snap.val()).forEach(key => {
              updates[key + '/nombre'] = nuevoNombre;
              updates[key + '/localidad'] = nuevaLocalidad;
              updates[key + '/direccion'] = nuevaDireccion;
              updates[key + '/provincia'] = nuevaProvincia;
              updates[key + '/dni'] = nuevoDni;
              updates[key + '/telefono'] = nuevoTelefono;
            });
          } else {
            const nuevoCliente = {
              nombre: nuevoNombre,
              localidad: nuevaLocalidad,
              direccion: nuevaDireccion,
              provincia: nuevaProvincia,
              dni: nuevoDni,
              telefono: nuevoTelefono,
              email: email
            };
            const nuevoKey = db.ref('clientes').push().key;
            updates[nuevoKey] = nuevoCliente;
          }
          return db.ref('clientes').update(updates);
        })
        .then(() => {
          alert('Datos del cliente actualizados');
          modalEditCliente.style.display = 'none';
        });
    } else {
      alert('Datos del cliente actualizados');
      modalEditCliente.style.display = 'none';
    }
  });
};
// Cerrar modal al hacer click fuera del contenido
modalEditCliente.addEventListener('mousedown', function(e) {
  if (e.target === modalEditCliente) {
    modalEditCliente.style.display = 'none';
  }
});


document.getElementById('ImprimirBtn').onclick = () => {
  if (!pedidoActual) return;
  const cliente = pedidoActual.cliente || {};
  
  // Ordenar items por categor√≠a
  const itemsOrdenados = [...pedidoActual.items].sort((a, b) => {
    const catA = (a.codigo && sheetCategoryMap[a.codigo]) || 'ZZZ'; // Items sin categor√≠a al final
    const catB = (b.codigo && sheetCategoryMap[b.codigo]) || 'ZZZ';
    return catA.localeCompare(catB);
  });
  
  // Calcular total de unidades
  const totalUnidades = itemsOrdenados.reduce((sum, it) => sum + (it.cantidad || 0), 0);
  
  // Generar URL de WhatsApp para el cliente
  let whatsappURL = '';
  if (cliente.telefono) {
    let telClean = cliente.telefono.replace(/[^\d]/g, '');
    if (telClean.startsWith('0')) telClean = telClean.substring(1);
    if (!telClean.startsWith('54')) telClean = '54' + telClean;
    whatsappURL = `https://api.whatsapp.com/send/?phone=${telClean}`;
  }
  
  // Generar QR usando API de QR Server
  const qrURL = whatsappURL ? `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(whatsappURL)}` : '';
  
  let html = `
    <html><head><title>Impresion de Pedido</title>
    <style>
      body { font-family: Arial, Helvetica, sans-serif; background: #fff; margin: 0; padding: 30px; }
      .header-container { position: relative; margin-bottom: 20px; }
      .info { font-size: 1.25em; display: inline-block; width: calc(100% - 120px); vertical-align: top; }
      .qr-container { position: absolute; top: 0; right: 0; width: 100px; height: 100px; }
      .qr-container img { width: 100px; height: 100px; }
      .table-container { position: relative; }
      .total-unidades { position: absolute; top: 0; right: 0; font-size: 1.1em; font-weight: bold; color: #4CAF50; }
      table { border-collapse: collapse; margin-bottom: 20px; table-layout: auto; }
  th, td { border: 1px solid #bbb; padding: 4px 15px; font-size: 0.9em; text-align: left; white-space: nowrap; }
  th { background: #4CAF50; color: #fff; }
  td.cant, th.cant, td.check, th.check { text-align: center; }
      @media print { button { display: none !important; } }
    </style>
    </head><body>
    <div class="header-container">
      <div class="info"><b>Nombre:</b> ${cliente.nombre || ''} <br>
        <b>Direcci√≥n:</b> ${cliente.direccion || ''} - ${cliente.localidad || ''} <br>
        <b>Provincia:</b> ${cliente.provincia || ''} <br>
        <b>Tel√©fono:</b> ${cliente.telefono || ''} <br>
        <b>DNI:</b> ${cliente.dni || ''} <br>
        <b>Env√≠o:</b> ${pedidoActual.tipoEntrega || ''} <br>
        <br>
        <b>REMITENTE:</b><br>
        Javier Romero Perez / Tel. 011 2189-1006<br>
        Sargento Cabral 1945, Florida Oeste, Buenos Aires<br>
        <br>
      </div>
      ${qrURL ? `<div class="qr-container"><img src="${qrURL}" alt="WhatsApp QR"></div>` : ''}
    </div>
    <div class="table-container">
      <div class="total-unidades">Total Unidades: ${totalUnidades}</div>
      <table>
        <tr>
          <th>Art√≠culo</th>
          <th class="cant">Cant.</th>
          <th class="check"></th>
        </tr>
  `;
  itemsOrdenados.forEach(it => {
    html += `<tr>
      <td style="text-align:left;">${it.nombre}</td>
      <td class="cant">${it.cantidad}</td>
      <td><input type='checkbox' style='width:22px;height:22px;'></td>
    </tr>`;
  });
  html += `</table>
    </div>`;
  // Llama a imprimir autom√°ticamente al abrir la ventana
  html += `<script>window.onload = function(){ window.print(); }<\/script>`;
  html += `</body></html>`;
  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
};

// Mostrar bot√≥n Imprimir solo para admin y moverlo al bloque de acciones admin
if (admin) {
  const ImprimirBtn = document.getElementById('ImprimirBtn');
  ImprimirBtn.style.display = 'inline-block';
  
  // Mover el bot√≥n ImprimirBtn al bloque de acciones admin
  const accionesAdmin = document.getElementById('accionesAdmin');
  if (accionesAdmin && ImprimirBtn) {
    accionesAdmin.insertBefore(ImprimirBtn, accionesAdmin.firstChild);
  }
}

// === REGISTRO AUTOM√ÅTICO DE MOVIMIENTOS DE SALIDA (S√ìLO CAMPOS B√ÅSICOS) ===
/**
 * Lee el pedido actualizado y registra todos los art√≠culos como movimientos de salida en Firebase.
 * @param {string} pedidoId - ID del pedido
 * @returns {Promise<void>}
 */
async function registrarMovimientoSalidaDesdePedido(pedidoId) {
  const pedidoSnap = await db.ref('pedidos/' + pedidoId).once('value');
  const pedido = pedidoSnap.val();
  if (!pedido || !Array.isArray(pedido.items) || !pedido.items.length) throw new Error('No hay art√≠culos para registrar en movimientos.');
  const movimientosRef = db.ref('movimientos');
  const timestamp = Date.now();
  const updates = {};
  for (const it of pedido.items) {
    const nombre = it.nombre || '';
    const cantidad = it.cantidad || 0;
    const codigo = it.codigo || '';
    if (!nombre) continue; // No registrar si no hay nombre
    const key = movimientosRef.push().key;
    updates[key] = {
      timestamp,
      pedidoId,
      nombre,
      cantidad,
      codigo,
      tipo: 'SALIDA'
    };
  }
  if (Object.keys(updates).length === 0) throw new Error('No hay art√≠culos v√°lidos para registrar en movimientos.');
  await movimientosRef.update(updates);
}

// === HABILITAR/DESHABILITAR BOTONES SEG√öN ENTREGA ===
function actualizarEstadoBotonesPorEntrega() {
  const entregaSeleccionada = document.querySelector('input[name="tipoEntrega"]:checked');
  const despachadoEntregadoBtn = document.getElementById('despachadoEntregadoBtn');
  // Solo deshabilitar despachadoEntregadoBtn si no hay seleccionada o es Retiro en local
  if (!entregaSeleccionada || entregaSeleccionada.value === 'Retiro en local') {
    if (despachadoEntregadoBtn) despachadoEntregadoBtn.disabled = true;
    if (despachadoEntregadoBtn) despachadoEntregadoBtn.style.opacity = '0.5';
  } else {
    // Deshabilitar solo si status es CANCELADO, DESPACHADO/ENTREGADO, o si locked y status NO es CERRADO
    const bloqueado = pedidoActual && (
      pedidoActual.status === 'CANCELADO' ||
      pedidoActual.status === 'DESPACHADO/ENTREGADO' ||
      (pedidoActual.locked && pedidoActual.status !== 'CERRADO')
    );
    if (despachadoEntregadoBtn) {
      despachadoEntregadoBtn.disabled = bloqueado;
      despachadoEntregadoBtn.style.opacity = bloqueado ? '0.5' : '1';
    }
  }
}

// Asignar listeners a los radios de entrega
function asignarListenersEntrega() {
  const entregaRadios = document.getElementsByName('tipoEntrega');
  for (let r of entregaRadios) {
    r.removeEventListener('change', actualizarEstadoBotonesPorEntrega); // Evita listeners duplicados
    r.addEventListener('change', actualizarEstadoBotonesPorEntrega);
  }
  // Llamar al inicio para el estado inicial
  actualizarEstadoBotonesPorEntrega();
}

// Asignar listeners a los radios de tipo de pago para ALIAS (solo admin)
function asignarListenersTipoPago() {
  if (!admin) return; // Solo para administradores
  
  const pagoRadios = document.getElementsByName('tipoPago');
  for (let r of pagoRadios) {
    r.removeEventListener('change', actualizarVisibilidadAlias); // Evita listeners duplicados
    r.addEventListener('change', actualizarVisibilidadAlias);
  }
  // Configurar el campo ALIAS para may√∫sculas
  configurarCampoAlias();
  // Llamar al inicio para el estado inicial
  actualizarVisibilidadAlias();
}

// Llamar despu√©s de renderItems para asegurar que los radios existen
const observer = new MutationObserver(() => {
  let entregaConfigured = false;
  let pagoConfigured = false;
  
  if (document.getElementsByName('tipoEntrega').length > 0) {
    asignarListenersEntrega();
    entregaConfigured = true;
  }
  
  if (admin && document.getElementsByName('tipoPago').length > 0) {
    asignarListenersTipoPago();
    pagoConfigured = true;
  }
  
  // Solo desconectar cuando ambos est√©n configurados (o cuando pago no sea necesario para no-admin)
  if (entregaConfigured && (pagoConfigured || !admin)) {
    observer.disconnect();
  }
});
observer.observe(document.body, { childList: true, subtree: true });
</script>

<div style="max-width:600px;margin:30px auto 0 auto;font-size:0.90em;color:#444;text-align:left;opacity:0.85;">
  <hr style="margin:18px 0;">
  <div style="margin-bottom:10px;">* Los precios se congelan √∫nicamente al momento de CERRAR el pedido.</div>
  <div style="margin-bottom:10px;">** La cotizaci√≥n final se mantendr√° vigente √∫nicamente durante el d√≠a en curso, en caso de demorarse el pago se recotizar√° el total.</div>
  <div style="margin-bottom:10px;">*** En caso de requerirlo, los env√≠os se despachan a sucursales para reducir costos de env√≠o. La cotizaci√≥n se encuentra sujeta a la distancia, el tama√±o y el peso final del pedido.</div>
</div>
</body>
</html>